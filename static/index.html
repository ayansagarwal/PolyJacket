<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PolyJacket - GT IM Prediction Market</title>
</head>
<body>
  <div id="app"></div>
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <script>
    // Custom Chart.js interaction mode: show tooltip at any x hover position
    // for stepped lines (finds last known value at cursor position).
    Chart.Interaction.modes.steppedHover = function(chart, e, options) {
      const mouseX = e.x;
      const items = [];
      chart.data.datasets.forEach(function(dataset, datasetIndex) {
        const meta = chart.getDatasetMeta(datasetIndex);
        if (!meta.visible) return;
        const pts = meta.data;
        // Walk forward; keep the last index whose pixel x <= cursor x
        let found = -1;
        for (let i = 0; i < pts.length; i++) {
          if (pts[i].x <= mouseX) found = i;
          else break;
        }
        if (found >= 0) {
          items.push({ datasetIndex: datasetIndex, index: found, element: pts[found] });
        }
      });
      return items;
    };
  </script>
  
  <script type="module">
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
    
    createApp({
      setup() {
        // Dark mode
        const darkMode = ref(localStorage.getItem('darkMode') === 'true');
        if (darkMode.value) document.documentElement.classList.add('dark');
        function toggleDarkMode() {
          darkMode.value = !darkMode.value;
          localStorage.setItem('darkMode', darkMode.value);
          document.documentElement.classList.toggle('dark', darkMode.value);
        }

        // Authentication State
        const isLoggedIn = ref(false);
        const user = ref(null);
        const token = ref(null);
        const showAuthModal = ref(false);
        const authMode = ref('login'); // 'login' or 'register'
        const authUsername = ref('');
        const authEmail = ref('');
        const authPassword = ref('');
        const authError = ref('');
        const authProcessing = ref(false);
        
        // State
        const loading = ref(true);
        const error = ref(null);
        const markets = ref([]);
        const portfolio = ref(null);
        const userBalance = ref(0);
        const selectedSport = ref('All');
        const selectedDate = ref('All');
        const activeTab = ref('markets'); // 'markets', 'portfolio', or 'raffle'

        // Raffle state
        const raffleData = ref(null);
        const raffleBuying = ref(false);
        const raffleError = ref(null);
        const raffleSuccess = ref(null);
        const userRaffleTokens = ref(0);

        // Admin state
        const isAdmin = computed(() => isLoggedIn.value && user.value?.username === 'superuser');
        const adminUsers = ref([]);
        const adminUsersLoading = ref(false);
        const adminPositions = ref([]);
        const adminPositionsLoading = ref(false);
        const adminRaffleWinners = ref([]);
        const adminRaffleLastWinner = ref(null);
        const adminRaffleRunning = ref(false);
        const adminRaffleClosing = ref(false);
        const adminRaffleError = ref(null);
        const adminSettleMarketId = ref('');
        const adminSettleHomeScore = ref('');
        const adminSettleAwayScore = ref('');
        const adminSettleResult = ref(null);
        const adminSettleError = ref(null);
        const adminSettleProcessing = ref(false);
        const adminScoreCheck = ref(null);
        const adminScoreCheckLoading = ref(false);
        const adminAllMarkets = ref([]);
        const showTradeModal = ref(false);
        const selectedMarket = ref(null);
        const tradeOutcome = ref('home');
        const tradeAmount = ref(100);
        const tradeProcessing = ref(false);
        const tradeResult = ref(null);

        // Sell state
        const showSellModal = ref(false);
        const sellPosition = ref(null);   // position being sold
        const sellMarket = ref(null);     // corresponding market object
        const sellOutcome = ref('home');  // 'home' or 'away'
        const sellShares = ref(0);
        const sellProcessing = ref(false);
        const sellResult = ref(null);
        const sellPreview = ref(null);    // estimated tokens to receive

        // Price chart state
        const showPriceChart = ref(false);
        const priceChartData = ref(null);
        const priceChartInstance = ref(null);
        const priceChartCanvasRef = ref(null); // Vue template ref — always current DOM element
        const chartRawHistory = ref([]);  // full history, unfiltered
        const chartView = ref('1w');      // '1h', '1d', '1w'
        let priceChartGen = 0; // generation counter for rAF safety

        // Expanded game view state
        const showExpandedView = ref(false);
        const expandedMarket = ref(null);
        const expandedChartInstance = ref(null);
        const expandedChartCanvasRef = ref(null);
        const expandedChartView = ref('1w');
        const expandedChartKey = ref(0);
        const expandedChartHistory = ref([]);
        let expandedChartGen = 0; // generation counter — stale rAF callbacks self-abort
        
        // Chat state
        const chatMessages = ref([]);
        const chatMessage = ref('');
        const chatLoading = ref(false);
        const chatError = ref(null);
        // Score report state
        const showScoreReport = ref(false);
        const scoreReportHome = ref('');
        const scoreReportAway = ref('');
        const scoreReportLoading = ref(false);
        const userScoreCheck = ref(null);
        const userScoreCheckLoading = ref(false);
        const userScoreCheckConfirmed = ref(false);

        // Computed
        const uniqueSports = computed(() => {
          const sports = new Set(markets.value.map(m => m.sport));
          return Array.from(sports).sort();
        });

        const uniqueDates = computed(() => {
          const dates = new Set(markets.value.map(m => m.game_date).filter(d => d));
          return Array.from(dates).sort();
        });

        // Format game date+time as "Today at 5:00 pm", "Tomorrow at 4:00 pm", "2/25 at 6:00 pm"
        function formatGameTime(dateStr, timeStr) {
          const special = ['FINAL', 'BYE', 'FORFEIT'];
          if (!dateStr) return timeStr || '';
          const parts = dateStr.split('/');
          if (parts.length < 3) return dateStr + (timeStr ? ' at ' + timeStr : '');
          const [mo, da, yr] = parts;
          const gameDate = new Date(+yr, +mo - 1, +da);
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
          let dateLabel;
          if (gameDate.getTime() === today.getTime()) dateLabel = 'Today';
          else if (gameDate.getTime() === tomorrow.getTime()) dateLabel = 'Tomorrow';
          else dateLabel = `${+mo}/${+da}`;
          if (!timeStr || timeStr === 'TBD') return `${dateLabel} · TBD`;
          if (special.includes(timeStr.toUpperCase())) return `${dateLabel} · ${timeStr}`;
          return `${dateLabel} at ${timeStr.toLowerCase()}`;
        }

        // Parse a market's date + time into a sortable timestamp
        function gameDateTime(m) {
          try {
            const [mo, da, yr] = (m.game_date || '').split('/');
            const t = m.game_time || '';
            if (!t || t === 'TBD') return new Date(yr, mo - 1, da, 23, 59, 0).getTime();
            if (t === 'FINAL' || t === 'BYE' || t === 'FORFEIT') return new Date(yr, mo - 1, da, 23, 59, 59).getTime();
            return new Date(`${m.game_date} ${t}`).getTime();
          } catch { return Infinity; }
        }

        const filteredMarkets = computed(() => {
          let filtered = markets.value;
          
          // Filter by sport
          if (selectedSport.value !== 'All') {
            filtered = filtered.filter(m => m.sport === selectedSport.value);
          }
          
          // Filter by date
          if (selectedDate.value !== 'All') {
            filtered = filtered.filter(m => m.game_date === selectedDate.value);
          }

          // Sort: open first, then closed, then settled; soonest game first within each group
          const statusOrder = { open: 0, closed: 1, settled: 2 };
          filtered = [...filtered].sort((a, b) => {
            const sd = (statusOrder[a.status] ?? 1) - (statusOrder[b.status] ?? 1);
            if (sd !== 0) return sd;
            return gameDateTime(a) - gameDateTime(b);
          });
          
          return filtered;
        });

        const openMarkets = computed(() => 
          filteredMarkets.value.filter(m => m.status === 'open')
        );

        const closedMarkets = computed(() => 
          filteredMarkets.value.filter(m => m.status === 'closed')
        );

        const settledMarkets = computed(() => 
          filteredMarkets.value.filter(m => m.status === 'settled')
        );

        // Removed totalValue - now just showing balance

        const openPositions = computed(() => {
          if (!portfolio.value) return [];
          return portfolio.value.open_positions || [];
        });

        const settledPositions = computed(() => {
          if (!portfolio.value) return [];
          return portfolio.value.settled_positions || [];
        });

        // Get user's position for the expanded market
        const expandedMarketPosition = computed(() => {
          if (!expandedMarket.value || !portfolio.value) return null;
          const allPositions = [...(portfolio.value.open_positions || []), ...(portfolio.value.settled_positions || [])];
          return allPositions.find(p => p.market_id === expandedMarket.value.market_id) || null;
        });

        // Helper to get today's date in the same format as game dates
        function getTodayDate() {
          const today = new Date();
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const month = months[today.getMonth()];
          const day = today.getDate();
          const year = today.getFullYear();
          return `${month} ${day}, ${year}`;
        }

        // Authentication Methods
        function checkAuth() {
          const savedToken = localStorage.getItem('auth_token');
          const savedUser = localStorage.getItem('user');
          if (savedToken && savedUser) {
            token.value = savedToken;
            user.value = JSON.parse(savedUser);
            isLoggedIn.value = true;
          }
        }

        async function login() {
          try {
            authProcessing.value = true;
            authError.value = '';
            const response = await fetch('/api/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: authUsername.value,
                password: authPassword.value
              })
            });
            
            if (!response.ok) {
              const data = await response.json();
              throw new Error(data.detail || 'Login failed');
            }
            
            const data = await response.json();
            token.value = data.access_token;
            user.value = { username: data.username, user_id: data.user_id };
            isLoggedIn.value = true;
            
            localStorage.setItem('auth_token', data.access_token);
            localStorage.setItem('user', JSON.stringify(user.value));
            
            showAuthModal.value = false;
            authUsername.value = '';
            authPassword.value = '';
            
            await fetchUser();
            await fetchPortfolio();
            await fetchMarkets();
          } catch (err) {
            authError.value = err.message;
          } finally {
            authProcessing.value = false;
          }
        }

        async function register() {
          try {
            authProcessing.value = true;
            authError.value = '';
            const response = await fetch('/api/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: authUsername.value,
                email: authEmail.value,
                password: authPassword.value
              })
            });
            
            if (!response.ok) {
              const data = await response.json();
              throw new Error(data.detail || 'Registration failed');
            }
            
            const data = await response.json();
            token.value = data.access_token;
            user.value = { username: data.username, user_id: data.user_id };
            isLoggedIn.value = true;
            
            localStorage.setItem('auth_token', data.access_token);
            localStorage.setItem('user', JSON.stringify(user.value));
            
            showAuthModal.value = false;
            authUsername.value = '';
            authEmail.value = '';
            authPassword.value = '';
            
            await fetchUser();
            await fetchPortfolio();
            await fetchMarkets();
          } catch (err) {
            authError.value = err.message;
          } finally {
            authProcessing.value = false;
          }
        }

        function logout() {
          token.value = null;
          user.value = null;
          isLoggedIn.value = false;
          localStorage.removeItem('auth_token');
          localStorage.removeItem('user');
          portfolio.value = null;
          userBalance.value = 0;
          activeTab.value = 'markets';
        }

        function openAuthModal(mode = 'login') {
          authMode.value = mode;
          authError.value = '';
          showAuthModal.value = true;
        }

        // Methods
        async function fetchMarkets() {
          try {
            loading.value = true;
            error.value = null;
            const response = await fetch('/api/markets');
            const data = await response.json();
            if (data.success) {
              markets.value = data.markets;
              // Sort by status: open first, then closed, then settled
              markets.value.sort((a, b) => {
                const statusOrder = { 'open': 0, 'closed': 1, 'settled': 2 };
                return statusOrder[a.status] - statusOrder[b.status];
              });
              
              // Auto-select today's date if available
              const todayDate = getTodayDate();
              const dates = new Set(markets.value.map(m => m.game_date).filter(d => d));
              if (dates.has(todayDate) && selectedDate.value === 'All') {
                selectedDate.value = todayDate;
              }
            } else {
              error.value = 'Failed to load markets';
            }
          } catch (err) {
            error.value = 'Error connecting to server';
            console.error(err);
          } finally {
            loading.value = false;
          }
        }

        async function fetchUser() {
          if (!token.value) return;
          try {
            const response = await fetch('/api/user', {
              headers: {
                'Authorization': `Bearer ${token.value}`
              }
            });
            if (response.ok) {
              const data = await response.json();
              userBalance.value = data.balance;
              user.value = {
                ...user.value,
                email: data.email,
                balance: data.balance
              };
              if (data.raffle_tokens != null) userRaffleTokens.value = data.raffle_tokens;
            }
          } catch (err) {
            console.error('Error fetching user:', err);
          }
        }

        async function fetchPortfolio() {
          if (!token.value) return;
          try {
            const response = await fetch('/api/portfolio', {
              headers: {
                'Authorization': `Bearer ${token.value}`
              }
            });
            if (response.ok) {
              const data = await response.json();
              portfolio.value = data;
              userBalance.value = data.balance;
            }
          } catch (err) {
            console.error('Error fetching portfolio:', err);
          }
        }

        // ---- Sell functionality ----
        function openSellModal(position, outcome) {
          const market = markets.value.find(m => m.market_id === position.market_id);
          if (!market) return;
          sellPosition.value = position;
          sellMarket.value = market;
          sellOutcome.value = outcome;
          const maxShares = outcome === 'home' ? position.home_shares : position.away_shares;
          sellShares.value = parseFloat(maxShares.toFixed(4));
          sellResult.value = null;
          updateSellPreview();
          showSellModal.value = true;
        }

        function closeSellModal() {
          showSellModal.value = false;
          sellPosition.value = null;
          sellMarket.value = null;
          sellResult.value = null;
          sellPreview.value = null;
        }

        function updateSellPreview() {
          if (!sellMarket.value || !sellShares.value || sellShares.value <= 0) {
            sellPreview.value = null;
            return;
          }
          // LMSR sell-back: before - after of cost function (mirrors backend)
          const b = 100;
          const shares = parseFloat(sellShares.value);
          let currentSide, otherSide;
          if (sellOutcome.value === 'home') {
            currentSide = sellMarket.value.home_shares;
            otherSide   = sellMarket.value.away_shares;
          } else {
            currentSide = sellMarket.value.away_shares;
            otherSide   = sellMarket.value.home_shares;
          }
          const before = b * Math.log(Math.exp(currentSide / b) + Math.exp(otherSide / b));
          const after  = b * Math.log(Math.exp((currentSide - shares) / b) + Math.exp(otherSide / b));
          sellPreview.value = Math.max(0, before - after);
        }

        async function executeSell() {
          if (!token.value) return;
          try {
            sellProcessing.value = true;
            sellResult.value = null;
            const response = await fetch('/api/sell', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token.value}`
              },
              body: JSON.stringify({
                market_id: sellPosition.value.market_id,
                outcome: sellOutcome.value,
                shares: parseFloat(sellShares.value)
              })
            });
            const data = await response.json();
            if (response.ok && data.success) {
              sellResult.value = { success: true, message: data.message };
              await fetchMarkets();
              await fetchPortfolio();
              setTimeout(() => {
                closeSellModal();
              }, 1800);
            } else {
              sellResult.value = { success: false, message: data.detail || 'Sell failed' };
            }
          } catch (err) {
            sellResult.value = { success: false, message: 'Error executing sell' };
          } finally {
            sellProcessing.value = false;
          }
        }

        // ---- Price chart ----

        // Parse SQLite UTC timestamp string → local Date object
        function parseUTC(ts) {
          if (!ts) return new Date();
          // SQLite CURRENT_TIMESTAMP: "YYYY-MM-DD HH:MM:SS" — treat as UTC
          return new Date(ts.trim().replace(' ', 'T') + 'Z');
        }

        async function openPriceChart(market) {
          selectedMarket.value = market;
          showPriceChart.value = true;
          priceChartData.value = null;
          chartView.value = '1w';
          chartRawHistory.value = [];
          if (priceChartInstance.value) {
            priceChartInstance.value.destroy();
            priceChartInstance.value = null;
          }
          try {
            const res = await fetch(`/api/markets/${market.market_id}/history`);
            const data = await res.json();
            if (data.success) {
              priceChartData.value = data.history;
              chartRawHistory.value = data.history;
              await nextTick();
              renderPriceChart(data.history, market);
            } else {
              priceChartData.value = [];
            }
          } catch (err) {
            console.error('Failed to load price history:', err);
            priceChartData.value = [];
          }
        }

        function closePriceChart() {
          if (priceChartInstance.value) {
            priceChartInstance.value.destroy();
            priceChartInstance.value = null;
          }
          showPriceChart.value = false;
          priceChartData.value = null;
          chartRawHistory.value = [];
        }

        function setChartView(v) {
          chartView.value = v;
          if (priceChartInstance.value) {
            try { priceChartInstance.value.destroy(); } catch (_) {}
            priceChartInstance.value = null;
          }
          const myGen = ++priceChartGen;
          requestAnimationFrame(() => {
            if (myGen !== priceChartGen) return;
            renderPriceChart(chartRawHistory.value, selectedMarket.value);
          });
        }

        function renderPriceChart(history, market) {
          // Use Vue template ref so we always get the current live canvas element
          const canvas = priceChartCanvasRef.value;
          if (!canvas || !history.length) return;

          // Destroy via Vue ref
          if (priceChartInstance.value) {
            try { priceChartInstance.value.destroy(); } catch (_) {}
            priceChartInstance.value = null;
          }
          // Safety net: destroy any orphaned Chart.js instance on the canvas
          const orphan = Chart.getChart(canvas);
          if (orphan) { try { orphan.destroy(); } catch (_) {} }

          // Build time-based data points, converting UTC → local Date objects
          const points = history.map(h => ({
            x: parseUTC(h.timestamp),
            home: h.home_price,
            away: h.away_price
          }));

          // Determine x-axis window based on selected view
          const now = new Date();
          let xMin;
          if (chartView.value === '1h') {
            xMin = new Date(now.getTime() - 3600 * 1000);
          } else if (chartView.value === '1d') {
            xMin = new Date(now.getTime() - 86400 * 1000);
          } else {
            xMin = new Date(now.getTime() - 7 * 86400 * 1000);
          }

          // Split into points before and within the window
          const before = points.filter(p => p.x < xMin);
          const after  = points.filter(p => p.x >= xMin);

          // Left anchor: last known price before the window, placed exactly at xMin.
          // If no prior point exists, use the very first point's price (opening price).
          const leftSrc = before.length ? before[before.length - 1] : (points[0] || { home: 50, away: 50 });
          const leftAnchor = { x: new Date(xMin), home: leftSrc.home, away: leftSrc.away };

          // Right anchor: extend last known price to 'now' so the line fills the window.
          const rightSrc = after.length ? after[after.length - 1] : leftSrc;
          const rightAnchor = { x: new Date(now), home: rightSrc.home, away: rightSrc.away };

          // Combine: left anchor → points within window → right anchor
          // Deduplicate in case a point lands exactly on xMin or now
          const visiblePoints = [leftAnchor, ...after, rightAnchor];

          // Determine tick granularity for readability
          let timeUnit, tooltipFmt;
          if (chartView.value === '1h') {
            timeUnit = 'minute';
            tooltipFmt = 'h:mm a';
          } else if (chartView.value === '1d') {
            timeUnit = 'hour';
            tooltipFmt = 'h:mm a';
          } else {
            timeUnit = 'day';
            tooltipFmt = 'MMM d, h:mm a';
          }

          priceChartInstance.value = new Chart(canvas, {
            type: 'line',
            data: {
              datasets: [
                {
                  label: `${market.home_team}`,
                  data: visiblePoints.map(p => ({ x: p.x, y: p.home })),
                  borderColor: '#667eea',
                  backgroundColor: 'rgba(102,126,234,0.08)',
                  stepped: 'before',
                  tension: 0,
                  fill: true,
                  pointRadius: 0,
                  pointHoverRadius: 4,
                  pointHoverBackgroundColor: '#667eea',
                  borderWidth: 2,
                  yAxisID: 'yHome'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'steppedHover', intersect: false, axis: 'x' },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    title: items => items[0] ? items[0].label : '',
                    label: ctx => {
                      const home = ctx.parsed.y;
                      const away = 100 - home;
                      return [
                        `${market.home_team}: ${home.toFixed(1)}¢`,
                        `${market.away_team}: ${away.toFixed(1)}¢`
                      ];
                    }
                  }
                }
              },
              scales: {
                x: {
                  type: 'time',
                  time: {
                    unit: timeUnit,
                    tooltipFormat: tooltipFmt,
                    displayFormats: {
                      minute: 'h:mm a',
                      hour:   'h a',
                      day:    'MMM d'
                    }
                  },
                  min: xMin,
                  max: now,
                  ticks: { display: false },
                  grid: { display: false }
                },
                yHome: {
                  position: 'left',
                  min: 0,
                  max: 100,
                  ticks: { callback: v => v + '¢' },
                  title: { display: true, text: `${market.home_team} →`, color: '#667eea', font: { weight: 'bold' } },
                  grid: { color: 'rgba(0,0,0,0.06)' }
                },
                yAway: {
                  position: 'right',
                  min: 0,
                  max: 100,
                  ticks: { callback: v => (100 - v) + '¢' },
                  title: { display: true, text: `← ${market.away_team}`, color: '#f97316', font: { weight: 'bold' } },
                  grid: { drawOnChartArea: false }
                }
              }
            }
          });
        }


        async function executeTrade() {
          if (!token.value) {
            openAuthModal('login');
            return;
          }
          
          try {
            tradeProcessing.value = true;
            tradeResult.value = null;
            
            const response = await fetch('/api/trade', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token.value}`
              },
              body: JSON.stringify({
                market_id: selectedMarket.value.market_id,
                outcome: tradeOutcome.value,
                amount: parseFloat(tradeAmount.value)
              })
            });

            const data = await response.json();
            
            if (response.ok && data.success) {
              tradeResult.value = {
                success: true,
                message: `Successfully purchased ${data.shares_purchased} shares at ${data.price_per_share.toFixed(2)} tokens per share!`,
                data: data
              };
              
              // Refresh data
              await fetchMarkets();
              await fetchPortfolio();
              
              // Reset form
              setTimeout(() => {
                showTradeModal.value = false;
                tradeResult.value = null;
                tradeAmount.value = 100;
              }, 2000);
            } else {
              tradeResult.value = {
                success: false,
                message: data.detail || 'Trade failed'
              };
            }
          } catch (err) {
            tradeResult.value = {
              success: false,
              message: 'Error executing trade'
            };
            console.error(err);
          } finally {
            tradeProcessing.value = false;
          }
        }

        function openTradeModal(market) {
          selectedMarket.value = market;
          showTradeModal.value = true;
          tradeOutcome.value = 'home';
          tradeAmount.value = 100;
          tradeResult.value = null;
        }

        function closeTradeModal() {
          showTradeModal.value = false;
          selectedMarket.value = null;
          tradeResult.value = null;
        }

        async function openExpandedView(market) {
          expandedChartGen = 0;
          expandedMarket.value = market;
          showExpandedView.value = true;
          chatMessages.value = [];
          chatMessage.value = '';
          chatError.value = null;
          
          // Load chat messages
          await loadChatMessages(market.market_id);
          
          // Load price history for the chart
          await loadExpandedChart(market);
        }

        function closeExpandedView() {
          expandedChartGen = 0;
          showExpandedView.value = false;
          expandedMarket.value = null;
          if (expandedChartInstance.value) {
            expandedChartInstance.value.destroy();
            expandedChartInstance.value = null;
          }
        }

        async function fetchRaffleData() {
          try {
            const headers = token.value ? { 'Authorization': `Bearer ${token.value}` } : {};
            const response = await fetch('/api/raffle', { headers });
            if (response.ok) {
              const data = await response.json();
              raffleData.value = data;
              if (data.user_raffle_tokens != null) userRaffleTokens.value = data.user_raffle_tokens;
            }
          } catch (err) {
            console.error('Error fetching raffle:', err);
          }
        }

        async function buyRaffleTickets(tierId) {
          if (!isLoggedIn.value) {
            raffleError.value = 'Please log in to buy raffle tickets';
            return;
          }
          raffleBuying.value = tierId;
          raffleError.value = null;
          raffleSuccess.value = null;
          try {
            const response = await fetch('/api/raffle/buy', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token.value}`
              },
              body: JSON.stringify({ tier_id: tierId })
            });
            const data = await response.json();
            if (data.success) {
              raffleSuccess.value = data.message;
              raffleData.value = { ...raffleData.value, total_tickets: data.total_tickets, user_tickets: data.user_tickets };
              userRaffleTokens.value = data.new_raffle_tokens;
            } else {
              raffleError.value = data.detail || 'Purchase failed';
            }
          } catch (err) {
            raffleError.value = 'Purchase failed';
          } finally {
            raffleBuying.value = false;
          }
        }

        // ===== ADMIN FUNCTIONS =====
        async function adminFetchMarkets() {
          try {
            const response = await fetch('/api/markets', { headers: { 'Authorization': `Bearer ${token.value}` } });
            const data = await response.json();
            adminAllMarkets.value = (data.markets || []).filter(m => m.status !== 'settled');
          } catch (e) { console.error('admin fetch markets', e); }
          // Load raffle winners + closed state
          try {
            const r = await fetch('/api/admin/raffle/status', { headers: { 'Authorization': `Bearer ${token.value}` } });
            if (r.ok) {
              const d = await r.json();
              adminRaffleWinners.value = d.winners || [];
            }
          } catch (e) { /* ignore */ }
          // Load users
          adminUsersLoading.value = true;
          try {
            const r = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${token.value}` } });
            if (r.ok) { const d = await r.json(); adminUsers.value = d.users || []; }
          } catch (e) { /* ignore */ } finally { adminUsersLoading.value = false; }
          // Load positions
          adminPositionsLoading.value = true;
          try {
            const r = await fetch('/api/admin/positions', { headers: { 'Authorization': `Bearer ${token.value}` } });
            if (r.ok) { const d = await r.json(); adminPositions.value = d.positions || []; }
          } catch (e) { /* ignore */ } finally { adminPositionsLoading.value = false; }
          fetchRaffleData();
        }

        async function adminRunRaffle() {
          adminRaffleRunning.value = true;
          adminRaffleError.value = null;
          adminRaffleLastWinner.value = null;
          try {
            const response = await fetch('/api/admin/raffle/run', {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token.value}` }
            });
            const data = await response.json();
            if (response.ok) {
              adminRaffleLastWinner.value = data.winner;
              adminRaffleWinners.value = data.all_winners || [];
              fetchRaffleData();
            } else {
              adminRaffleError.value = data.detail || 'Failed to draw winner';
            }
          } catch (e) {
            adminRaffleError.value = 'Request failed';
          } finally {
            adminRaffleRunning.value = false;
          }
        }

        async function adminCloseRaffle() {
          if (!confirm('Close the raffle? Ticket purchases will be disabled.')) return;
          adminRaffleClosing.value = true;
          try {
            const response = await fetch('/api/admin/raffle/close', {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token.value}` }
            });
            const data = await response.json();
            if (response.ok) { fetchRaffleData(); }
            else { adminRaffleError.value = data.detail || 'Failed to close raffle'; }
          } catch (e) { adminRaffleError.value = 'Request failed'; }
          finally { adminRaffleClosing.value = false; }
        }

        async function adminOpenRaffle() {
          adminRaffleClosing.value = true;
          try {
            const response = await fetch('/api/admin/raffle/open', {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token.value}` }
            });
            const data = await response.json();
            if (response.ok) { fetchRaffleData(); }
            else { adminRaffleError.value = data.detail || 'Failed to reopen raffle'; }
          } catch (e) { adminRaffleError.value = 'Request failed'; }
          finally { adminRaffleClosing.value = false; }
        }

        async function checkScoreCredibility() {
          adminScoreCheck.value = null;
          if (!adminSettleMarketId.value) return;
          const h = parseInt(adminSettleHomeScore.value);
          const a = parseInt(adminSettleAwayScore.value);
          if (isNaN(h) || isNaN(a) || h < 0 || a < 0) return;
          adminScoreCheckLoading.value = true;
          try {
            const params = new URLSearchParams({ market_id: adminSettleMarketId.value, home_score: h, away_score: a });
            const res = await fetch(`/api/admin/check-score?${params}`, {
              headers: { 'Authorization': `Bearer ${token.value}` }
            });
            if (res.ok) adminScoreCheck.value = await res.json();
          } catch { adminScoreCheck.value = null; }
          finally { adminScoreCheckLoading.value = false; }
        }

        let scoreCheckTimeout = null;
        watch([adminSettleHomeScore, adminSettleAwayScore, adminSettleMarketId], () => {
          adminScoreCheck.value = null;
          clearTimeout(scoreCheckTimeout);
          scoreCheckTimeout = setTimeout(checkScoreCredibility, 600);
        });

        async function adminSettleGame() {
          adminSettleError.value = null;
          adminSettleResult.value = null;
          if (!adminSettleMarketId.value) { adminSettleError.value = 'Select a market'; return; }
          const h = parseInt(adminSettleHomeScore.value);
          const a = parseInt(adminSettleAwayScore.value);
          if (isNaN(h) || isNaN(a)) { adminSettleError.value = 'Enter valid scores'; return; }
          adminSettleProcessing.value = true;
          try {
            const response = await fetch('/api/admin/settle-game', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token.value}` },
              body: JSON.stringify({ market_id: adminSettleMarketId.value, home_score: h, away_score: a })
            });
            const data = await response.json();
            if (response.ok) {
              adminSettleResult.value = data.message;
              adminSettleMarketId.value = '';
              adminSettleHomeScore.value = '';
              adminSettleAwayScore.value = '';
              fetchMarkets();
              adminFetchMarkets();
            } else {
              adminSettleError.value = data.detail || 'Settle failed';
            }
          } catch (e) {
            adminSettleError.value = 'Request failed';
          } finally {
            adminSettleProcessing.value = false;
          }
        }
        // ===========================

        async function loadChatMessages(marketId) {
          try {
            chatLoading.value = true;
            const response = await fetch(`/api/markets/${marketId}/chat`);
            const data = await response.json();
            if (data.success) {
              chatMessages.value = data.messages;
            }
          } catch (err) {
            console.error('Error loading chat:', err);
          } finally {
            chatLoading.value = false;
          }
        }

        async function sendChatMessage() {
          if (!chatMessage.value.trim()) return;
          if (!isLoggedIn.value) {
            chatError.value = 'Please log in to chat';
            return;
          }

          try {
            const response = await fetch(`/api/markets/${expandedMarket.value.market_id}/chat`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token.value}`
              },
              body: JSON.stringify({
                market_id: expandedMarket.value.market_id,
                message: chatMessage.value
              })
            });

            const data = await response.json();
            if (data.success) {
              chatMessages.value.push(data.message);
              chatMessage.value = '';
              chatError.value = null;
              // Scroll to bottom of chat
              await nextTick();
              const chatContainer = document.querySelector('.chat-messages');
              if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
              }
            } else {
              chatError.value = data.detail || 'Failed to send message';
            }
          } catch (err) {
            console.error('Error sending message:', err);
            chatError.value = 'Failed to send message';
          }
        }

        async function voteOnScoreReport(messageId, vote) {
          if (!isLoggedIn.value) return;
          try {
            const response = await fetch(`/api/markets/${expandedMarket.value.market_id}/score-report/${messageId}/vote`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token.value}`
              },
              body: JSON.stringify({ vote })
            });
            const data = await response.json();
            if (data.success) {
              const idx = chatMessages.value.findIndex(m => m.message_id === messageId);
              if (idx !== -1) chatMessages.value[idx] = data.message;
            }
          } catch (err) {
            console.error('Error voting:', err);
          }
        }

        async function sendScoreReport() {
          if (!isLoggedIn.value) {
            chatError.value = 'Please log in to report a score';
            return;
          }
          if (scoreReportHome.value === '' || scoreReportAway.value === '') {
            chatError.value = 'Enter scores for both teams';
            return;
          }
          // Run check if not yet done
          if (!userScoreCheck.value && !userScoreCheckLoading.value) {
            await checkUserScoreCredibility();
          }
          if (userScoreCheck.value?.severity === 'alert') {
            chatError.value = 'Score blocked: ' + (userScoreCheck.value.flags?.[0] || 'score appears invalid');
            return;
          }
          if (userScoreCheck.value?.severity === 'warning' && !userScoreCheckConfirmed.value) {
            userScoreCheckConfirmed.value = true;
            return;
          }
          scoreReportLoading.value = true;
          try {
            const response = await fetch(`/api/markets/${expandedMarket.value.market_id}/score-report`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token.value}`
              },
              body: JSON.stringify({
                home_score: parseInt(scoreReportHome.value),
                away_score: parseInt(scoreReportAway.value)
              })
            });
            const data = await response.json();
            if (data.success) {
              chatMessages.value.push(data.message);
              scoreReportHome.value = '';
              scoreReportAway.value = '';
              showScoreReport.value = false;
              userScoreCheck.value = null;
              userScoreCheckConfirmed.value = false;
              chatError.value = null;
              await nextTick();
              const chatContainer = document.querySelector('.chat-messages');
              if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
              chatError.value = data.detail || 'Failed to report score';
            }
          } catch (err) {
            console.error('Error reporting score:', err);
            chatError.value = 'Failed to report score';
          } finally {
            scoreReportLoading.value = false;
          }
        }

        async function checkUserScoreCredibility() {
          if (!expandedMarket.value) return;
          const h = parseInt(scoreReportHome.value);
          const a = parseInt(scoreReportAway.value);
          if (isNaN(h) || isNaN(a) || h < 0 || a < 0) { userScoreCheck.value = null; return; }
          userScoreCheckLoading.value = true;
          userScoreCheck.value = null;
          userScoreCheckConfirmed.value = false;
          try {
            const params = new URLSearchParams({ home_score: h, away_score: a });
            const res = await fetch(`/api/markets/${expandedMarket.value.market_id}/check-score?${params}`, {
              headers: token.value ? { 'Authorization': `Bearer ${token.value}` } : {}
            });
            if (res.ok) userScoreCheck.value = await res.json();
          } catch {}
          finally { userScoreCheckLoading.value = false; }
        }

        let userScoreCheckTimeout = null;
        watch([scoreReportHome, scoreReportAway], () => {
          userScoreCheck.value = null;
          userScoreCheckConfirmed.value = false;
          clearTimeout(userScoreCheckTimeout);
          if (scoreReportHome.value !== '' && scoreReportAway.value !== '') {
            userScoreCheckTimeout = setTimeout(checkUserScoreCredibility, 600);
          }
        });

        async function loadExpandedChart(market) {
          try {
            const response = await fetch(`/api/markets/${market.market_id}/history`);
            const data = await response.json();
            if (data.success) {
              expandedChartHistory.value = data.history;
              await nextTick();
              renderExpandedChart(market, data.history);
            }
          } catch (err) {
            console.error('Error loading chart:', err);
          }
        }

        function renderExpandedChart(market, history) {
          const canvas = expandedChartCanvasRef.value;
          if (!canvas) return;

          // Destroy via Vue ref
          if (expandedChartInstance.value) {
            try { expandedChartInstance.value.destroy(); } catch (_) {}
            expandedChartInstance.value = null;
          }
          // Safety net: destroy any Chart.js instance registered on the canvas
          // (catches leaks from rapid clicks where the ref wasn't updated yet)
          const orphan = Chart.getChart(canvas);
          if (orphan) { try { orphan.destroy(); } catch (_) {} }

          const parseUTC = (isoStr) => new Date(isoStr + 'Z');
          const points = history.map(h => ({
            x: parseUTC(h.timestamp),
            home: h.home_price,
            away: h.away_price
          }));

          const now = new Date();
          let xMin;
          if (expandedChartView.value === '1h') {
            xMin = new Date(now.getTime() - 3600 * 1000);
          } else if (expandedChartView.value === '1d') {
            xMin = new Date(now.getTime() - 86400 * 1000);
          } else {
            xMin = new Date(now.getTime() - 7 * 86400 * 1000);
          }

          const before = points.filter(p => p.x < xMin);
          const after = points.filter(p => p.x >= xMin);

          const leftSrc = before.length ? before[before.length - 1] : (points[0] || { home: 50, away: 50 });
          const leftAnchor = { x: new Date(xMin), home: leftSrc.home, away: leftSrc.away };

          const rightSrc = after.length ? after[after.length - 1] : leftSrc;
          const rightAnchor = { x: new Date(now), home: rightSrc.home, away: rightSrc.away };

          const visiblePoints = [leftAnchor, ...after, rightAnchor];

          let timeUnit, tooltipFmt;
          if (expandedChartView.value === '1h') {
            timeUnit = 'minute';
            tooltipFmt = 'h:mm a';
          } else if (expandedChartView.value === '1d') {
            timeUnit = 'hour';
            tooltipFmt = 'h:mm a';
          } else {
            timeUnit = 'day';
            tooltipFmt = 'MMM d, h:mm a';
          }

          expandedChartInstance.value = new Chart(canvas, {
            type: 'line',
            data: {
              datasets: [
                {
                  label: `${market.home_team}`,
                  data: visiblePoints.map(p => ({ x: p.x, y: p.home })),
                  borderColor: '#667eea',
                  backgroundColor: 'rgba(102,126,234,0.08)',
                  stepped: 'before',
                  tension: 0,
                  fill: true,
                  pointRadius: 0,
                  pointHoverRadius: 4,
                  pointHoverBackgroundColor: '#667eea',
                  borderWidth: 2
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'steppedHover', intersect: false, axis: 'x' },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    title: items => items[0] ? items[0].label : '',
                    label: ctx => {
                      const home = ctx.parsed.y;
                      const away = 100 - home;
                      return [
                        `${market.home_team}: ${home.toFixed(1)}¢`,
                        `${market.away_team}: ${away.toFixed(1)}¢`
                      ];
                    }
                  }
                }
              },
              scales: {
                x: {
                  type: 'time',
                  time: {
                    unit: timeUnit,
                    tooltipFormat: tooltipFmt,
                    displayFormats: {
                      minute: 'h:mm a',
                      hour: 'h a',
                      day: 'MMM d'
                    }
                  },
                  min: xMin,
                  max: now,
                  ticks: { display: false },
                  grid: { display: false }
                },
                y: {
                  min: 0,
                  max: 100,
                  ticks: {
                    callback: value => `${value}¢`
                  },
                  grid: { color: 'rgba(0,0,0,0.05)' }
                }
              }
            }
          });
        }

        function changeExpandedChartView(view) {
          expandedChartView.value = view;
          if (!expandedMarket.value || expandedChartHistory.value.length === 0) return;

          // Destroy immediately so the canvas is clean
          if (expandedChartInstance.value) {
            try { expandedChartInstance.value.destroy(); } catch (_) {}
            expandedChartInstance.value = null;
          }

          // Claim this generation; any rAF already in flight will see a stale gen and bail
          const myGen = ++expandedChartGen;
          requestAnimationFrame(() => {
            if (myGen !== expandedChartGen) return;
            renderExpandedChart(expandedMarket.value, expandedChartHistory.value);
          });
        }

        function getStatusColor(status) {
          return {
            'open': 'status-open',
            'closed': 'status-closed',
            'settled': 'status-settled'
          }[status] || '';
        }

        function getStatusIcon(status) {
          return {
            'open': '🟢',
            'closed': '🔴',
            'settled': '✅'
          }[status] || '';
        }

        function getStatusText(status) {
          return {
            'open': 'Open',
            'closed': 'Closed',
            'settled': 'Settled'
          }[status] || status;
        }

        function formatTokens(amount) {
          if (amount == null) return '0 🪙';
          return `${amount.toFixed(0)} 🪙`;
        }

        // Helper functions to handle trading from expanded view
        function buyFromExpandedView(outcome) {
          const market = expandedMarket.value;
          closeExpandedView();
          setTimeout(() => {
            openTradeModal(market);
            tradeOutcome.value = outcome;
          }, 100);
        }

        function sellFromExpandedView(outcome) {
          const position = expandedMarketPosition.value;
          closeExpandedView();
          setTimeout(() => {
            openSellModal(position, outcome);
          }, 100);
        }

        // Initialize
        onMounted(async () => {
          checkAuth();
          await fetchMarkets();
          if (isLoggedIn.value) {
            await fetchUser();
            await fetchPortfolio();
          }
        });

        return {
          // Auth
          isLoggedIn,
          user,
          showAuthModal,
          authMode,
          authUsername,
          authEmail,
          authPassword,
          authError,
          authProcessing,
          login,
          register,
          logout,
          openAuthModal,
          darkMode,
          toggleDarkMode,
          // State
          loading,
          error,
          markets,
          portfolio,
          userBalance,
          selectedSport,
          selectedDate,
          uniqueDates,
          activeTab,
          showTradeModal,
          selectedMarket,
          tradeOutcome,
          tradeAmount,
          tradeProcessing,
          tradeResult,
          uniqueSports,
          filteredMarkets,
          openMarkets,
          closedMarkets,
          settledMarkets,
          openPositions,
          settledPositions,
          // Methods
          fetchMarkets,
          fetchPortfolio,
          executeTrade,
          openTradeModal,
          closeTradeModal,
          getStatusColor,
          getStatusIcon,
          getStatusText,
          formatTokens,
          formatGameTime,
          // Sell
          showSellModal,
          sellPosition,
          sellMarket,
          sellOutcome,
          sellShares,
          sellProcessing,
          sellResult,
          sellPreview,
          openSellModal,
          closeSellModal,
          updateSellPreview,
          executeSell,
          // Price chart
          showPriceChart,
          priceChartData,
          priceChartCanvasRef,
          chartView,
          openPriceChart,
          closePriceChart,
          setChartView,
          // Expanded game view
          showExpandedView,
          expandedMarket,
          expandedChartCanvasRef,
          expandedChartView,
          expandedChartKey,
          expandedMarketPosition,
          openExpandedView,
          closeExpandedView,
          changeExpandedChartView,
          buyFromExpandedView,
          sellFromExpandedView,
          // Chat
          chatMessages,
          chatMessage,
          chatLoading,
          chatError,
          sendChatMessage,
          // Raffle
          raffleData,
          raffleBuying,
          raffleError,
          raffleSuccess,
          userRaffleTokens,
          fetchRaffleData,
          buyRaffleTickets,
          // Score report
          showScoreReport,
          scoreReportHome,
          scoreReportAway,
          scoreReportLoading,
          userScoreCheck,
          userScoreCheckLoading,
          userScoreCheckConfirmed,
          sendScoreReport,
          voteOnScoreReport,
          // Admin
          isAdmin,
          adminUsers,
          adminUsersLoading,
          adminPositions,
          adminPositionsLoading,
          adminRaffleWinners,
          adminRaffleLastWinner,
          adminRaffleRunning,
          adminRaffleClosing,
          adminRaffleError,
          adminSettleMarketId,
          adminSettleHomeScore,
          adminSettleAwayScore,
          adminSettleResult,
          adminSettleError,
          adminSettleProcessing,
          adminAllMarkets,
          adminRunRaffle,
          adminCloseRaffle,
          adminOpenRaffle,
          adminSettleGame,
          adminFetchMarkets,
          adminScoreCheck,
          adminScoreCheckLoading,
          checkScoreCredibility
        };
      },
      
      template: `
        <div class="app-container">
          <nav class="navbar">
            <div class="navbar-inner">
              <div class="navbar-brand">
                <span class="brand-name">PolyJacket</span>
              </div>
              <div class="navbar-tabs">
                <button :class="['nav-tab', { active: activeTab === 'markets' }]" @click="activeTab = 'markets'">Markets</button>
                <button :class="['nav-tab', { active: activeTab === 'portfolio' }]" @click="activeTab = 'portfolio'">Portfolio</button>
                <button :class="['nav-tab', { active: activeTab === 'raffle' }]" @click="activeTab = 'raffle'; fetchRaffleData()">Raffle</button>
                <button v-if="isAdmin" :class="['nav-tab', 'nav-tab-admin', { active: activeTab === 'admin' }]" @click="activeTab = 'admin'; adminFetchMarkets()">Admin</button>
              </div>
              <div class="navbar-actions">
                <button class="dark-mode-toggle" :class="{ active: darkMode }" @click="toggleDarkMode" :title="darkMode ? 'Light mode' : 'Dark mode'"></button>
                <div v-if="isLoggedIn" class="user-info">
                  <div class="balance">
                    <span class="label">Balance</span>
                    <span class="amount">{{ formatTokens(userBalance) }}</span>
                  </div>
                  <div class="username">
                    <span>{{ user.username }}</span>
                    <button class="btn-logout" @click="logout">Logout</button>
                  </div>
                </div>
                <div v-else class="auth-buttons">
                  <button class="btn-login" @click="openAuthModal('login')">Login</button>
                  <button class="btn-register" @click="openAuthModal('register')">Register</button>
                </div>
              </div>
            </div>
          </nav>

          <!-- Date Subnav -->
          <div v-if="activeTab === 'markets'" class="subnav subnav-chips">
            <button :class="['date-chip', { active: selectedDate === 'All' }]" @click="selectedDate = 'All'">All</button>
            <button v-for="date in uniqueDates" :key="date" :class="['date-chip', { active: selectedDate === date }]" @click="selectedDate = date">{{ date }}</button>
          </div>
          <!-- Date Dropdown (mobile only) -->
          <div v-if="activeTab === 'markets'" class="subnav-dropdown-wrap">
            <select class="date-dropdown" :value="selectedDate" @change="selectedDate = $event.target.value">
              <option value="All">All Dates</option>
              <option v-for="date in uniqueDates" :key="date" :value="date">{{ date }}</option>
            </select>
          </div>

          <!-- Loading State -->
          <div v-if="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading markets...</p>
          </div>

          <!-- Error State -->
          <div v-else-if="error" class="error">
            <p>❌ {{ error }}</p>
            <button @click="fetchMarkets" class="retry-btn">Retry</button>
          </div>

          <!-- Markets Tab -->
          <div v-else-if="activeTab === 'markets'" class="markets-tab">
            <!-- Markets Container -->
            <div class="markets-container">
              <!-- Sport Sidebar -->
              <div class="sport-sidebar">
                <h3 class="sidebar-title">Filter by Sport</h3>
                <div class="sport-list">
                  <button 
                    :class="['sport-btn', { active: selectedSport === 'All' }]"
                    @click="selectedSport = 'All'"
                  >
                    All Sports
                  </button>
                  <button 
                    v-for="sport in uniqueSports" 
                    :key="sport"
                    :class="['sport-btn', { active: selectedSport === sport }]"
                    @click="selectedSport = sport"
                  >
                    {{ sport }}
                  </button>
                </div>
              </div>

              <!-- Markets Content -->
              <div class="markets-content">

            <!-- Open Markets -->
            <div v-if="openMarkets.length > 0" class="market-section">
              <h1 class="section-title">Open Markets</h1>
              <div class="markets-grid">
                <div 
                  v-for="market in openMarkets" 
                  :key="market.market_id"
                  class="market-card open clickable"
                  @click="openExpandedView(market)"
                >
                  <div class="market-header">
                    <span class="sport-badge">{{ market.sport }}</span>
                    <span class="status-badge status-open">{{ getStatusText(market.status) }}</span>
                  </div>
                  
                  <div class="matchup">
                    <h3>{{ market.home_team }} vs {{ market.away_team }}</h3>
                    <div class="game-info">
                      <span>{{ formatGameTime(market.game_date, market.game_time) }}</span>
                    </div>
                  </div>

                  <div class="odds-section">
                    <div class="outcome-card home">
                      <div class="team-name">{{ market.home_team }}</div>
                      <div class="elo-badge" v-if="market.home_elo != null">Elo {{ market.home_elo }}</div>
                      <div class="price">{{ market.home_price.toFixed(1) }}¢</div>
                      <button 
                        class="buy-btn"
                        @click.stop="openTradeModal(market); tradeOutcome = 'home'"
                      >
                        Buy
                      </button>
                    </div>
                    
                    <div class="outcome-card away">
                      <div class="team-name">{{ market.away_team }}</div>
                      <div class="elo-badge" v-if="market.away_elo != null">Elo {{ market.away_elo }}</div>
                      <div class="price">{{ market.away_price.toFixed(1) }}¢</div>
                      <button 
                        class="buy-btn"
                        @click.stop="openTradeModal(market); tradeOutcome = 'away'"
                      >
                        Buy
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Closed Markets -->
            <div v-if="closedMarkets.length > 0" class="market-section">
              <h2 class="section-title">🔴 Closed Markets (Awaiting Results)</h2>
              <div class="markets-grid">
                <div 
                  v-for="market in closedMarkets" 
                  :key="market.market_id"
                  class="market-card closed clickable"
                  @click="openExpandedView(market)"
                >
                  <div class="market-header">
                    <span class="sport-badge">{{ market.sport }}</span>
                    <span class="status-badge status-closed">{{ getStatusText(market.status) }}</span>
                  </div>
                  
                  <div class="matchup">
                    <h3>{{ market.home_team }} vs {{ market.away_team }}</h3>
                    <div class="game-info">
                      <span>{{ formatGameTime(market.game_date, market.game_time) }}</span>
                    </div>
                  </div>

                  <div class="odds-section disabled">
                    <div class="outcome-card home">
                      <div class="team-name">{{ market.home_team }}</div>
                      <div class="elo-badge" v-if="market.home_elo != null">Elo {{ market.home_elo }}</div>
                      <div class="price">{{ market.home_price.toFixed(1) }}¢</div>
                    </div>
                    
                    <div class="outcome-card away">
                      <div class="team-name">{{ market.away_team }}</div>
                      <div class="elo-badge" v-if="market.away_elo != null">Elo {{ market.away_elo }}</div>
                      <div class="price">{{ market.away_price.toFixed(1) }}¢</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Settled Markets -->
            <div v-if="settledMarkets.length > 0" class="market-section">
              <h2 class="section-title">Settled Markets</h2>
              <div class="markets-grid">
                <div 
                  v-for="market in settledMarkets" 
                  :key="market.market_id"
                  class="market-card settled clickable"
                  @click="openExpandedView(market)"
                >
                  <div class="market-header">
                    <span class="sport-badge">{{ market.sport }}</span>
                    <span class="status-badge status-settled">{{ getStatusText(market.status) }}</span>
                  </div>
                  
                  <div class="matchup">
                    <h3>{{ market.home_team }} vs {{ market.away_team }}</h3>
                    <div v-if="market.home_score && market.away_score && market.home_score !== '--' && market.away_score !== '--'" class="final-score">
                      <span :class="['score', market.winner === 'home' ? 'winner' : 'loser']">{{ market.home_score }}</span>
                      <span class="score-separator">-</span>
                      <span :class="['score', market.winner === 'away' ? 'winner' : 'loser']">{{ market.away_score }}</span>
                    </div>
                  </div>

                  <div class="settlement-info">
                    <template v-if="market.winner === 'push'">
                      <div class="winner-banner push">
                        
                        <span>Game Voided</span>
                      </div>
                    </template>
                    <template v-else>
                      <div :class="['winner-banner', market.winner === 'home' ? 'home' : 'away']">
                        
                        <span>{{ market.winner === 'home' ? market.home_team : market.away_team }} Won</span>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </div>

            <div v-if="filteredMarkets.length === 0" class="no-markets">
              <p>No markets available</p>
            </div>
            </div>
            <!-- End markets-content -->
            </div>
            <!-- End markets-container -->
          </div>
          <!-- End markets-tab -->

          <!-- Portfolio Tab -->
          <div v-else-if="activeTab === 'portfolio'" class="portfolio-container">
            <div v-if="openPositions.length === 0 && settledPositions.length === 0" class="no-positions">
              <h2>No Positions Yet</h2>
              <p>Visit the Markets tab to start predicting!</p>
            </div>

            <div v-else>
              <!-- Open Positions -->
              <div v-if="openPositions.length > 0" class="positions-section">
                <h2 class="section-title">Open Positions</h2>
                <div class="positions-grid">
                  <div 
                    v-for="position in openPositions" 
                    :key="position.market_id"
                    class="position-card"
                  >
                    <h3>{{ position.game }}</h3>
                    <div class="position-details">
                      <div v-if="position.home_shares > 0" class="shares-info">
                        <span class="label">Shares:</span>
                        <span class="value">{{ position.home_shares.toFixed(2) }} @ {{ position.avg_home_price.toFixed(1) }}¢</span>
                      </div>
                      <div v-if="position.away_shares > 0" class="shares-info">
                        <span class="label">Shares:</span>
                        <span class="value">{{ position.away_shares.toFixed(2) }} @ {{ position.avg_away_price.toFixed(1) }}¢</span>
                      </div>
                      <div class="shares-info">
                        <span class="label">Current Value:</span>
                        <span class="value">{{ formatTokens(position.current_value) }}</span>
                      </div>
                      <div class="shares-info highlight">
                        <span class="label">Payout if Correct:</span>
                        <span class="value">{{ formatTokens(position.potential_payout) }}</span>
                      </div>
                      <div class="sell-actions">
                        <button v-if="position.home_shares > 0" class="sell-btn" @click="openSellModal(position, 'home')">
                          Sell ({{ position.home_shares.toFixed(2) }})
                        </button>
                        <button v-if="position.away_shares > 0" class="sell-btn" @click="openSellModal(position, 'away')">
                          Sell ({{ position.away_shares.toFixed(2) }})
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Settled Positions -->
              <div v-if="settledPositions.length > 0" class="positions-section">
                <h2 class="section-title">Settled Positions</h2>
                <div class="positions-grid">
                  <div 
                    v-for="position in settledPositions" 
                    :key="position.market_id"
                    class="position-card settled"
                  >
                    <h3>{{ position.game }}</h3>
                    <div class="position-details">
                      <div v-if="position.home_shares > 0" class="shares-info">
                        <span class="label">Home Shares:</span>
                        <span class="value">{{ position.home_shares.toFixed(2) }}</span>
                      </div>
                      <div v-if="position.away_shares > 0" class="shares-info">
                        <span class="label">Away Shares:</span>
                        <span class="value">{{ position.away_shares.toFixed(2) }}</span>
                      </div>
                      <div class="shares-info highlight">
                        <span class="label">Payout:</span>
                        <span class="value">{{ formatTokens(position.potential_payout) }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Raffle Tab -->
          <div v-else-if="activeTab === 'raffle'" class="raffle-container">
            <!-- Raffle Token Balance -->
            <div class="raffle-balance-bar">
              <div class="raffle-balance-main">
                <div class="raffle-balance-info">
                  <span class="raffle-balance-label">Your Raffle Tokens</span>
                  <span class="raffle-balance-amount">{{ Math.floor(userRaffleTokens).toLocaleString() }} RT</span>
                </div>
                <p class="raffle-balance-hint">Raffle tokens are earned automatically whenever you buy shares. 1 token spent = 1 RT earned.</p>
              </div>
            </div>

            <div v-if="!isLoggedIn" class="raffle-login-prompt">
              <p><a href="#" @click.prevent="openAuthModal('login')">Log in</a> to buy raffle tickets and see your entry count.</p>
            </div>

            <!-- Prize Card -->
            <div v-if="raffleData" class="raffle-prize-card">
              <img src="/static/actian-logo.png" alt="Actian" class="prize-logo">
              <div class="prize-info">
                <h2 class="prize-name">{{ raffleData.prize.name }}</h2>
                <p class="prize-desc">{{ raffleData.prize.description }}</p>
              </div>
              <div class="prize-odds">
                <div class="odds-number">{{ raffleData.user_tickets }}</div>
                <div class="odds-label">your tickets</div>
              </div>
            </div>

            <!-- Feedback -->
            <div v-if="raffleSuccess" class="raffle-success">{{ raffleSuccess }}</div>
            <div v-if="raffleError" class="raffle-error-msg">{{ raffleError }}</div>

            <!-- Tiers -->
            <div v-if="raffleData" class="raffle-tiers">
              <h3 class="tiers-heading">Buy Tickets</h3>
              <div class="tiers-grid">
                <div v-for="tier in raffleData.tiers" :key="tier.id" class="tier-card">
                  <div v-if="tier.pct_off > 0" class="tier-badge">{{ tier.pct_off }}% OFF</div>
                  <div class="tier-count">{{ tier.tickets }}<span class="tier-unit"> ticket{{ tier.tickets > 1 ? 's' : '' }}</span></div>
                  <div class="tier-label">{{ tier.label }}</div>
                  <div class="tier-cost">{{ tier.cost.toLocaleString() }} RT</div>
                  <div v-if="tier.savings > 0" class="tier-savings">saves {{ tier.savings }} RT</div>
                  <div v-else class="tier-savings-placeholder"></div>
                  <button
                    @click="buyRaffleTickets(tier.id)"
                    :disabled="!isLoggedIn || raffleBuying === tier.id || userRaffleTokens < tier.cost"
                    :class="['tier-buy-btn', { 'cant-afford': isLoggedIn && userRaffleTokens < tier.cost }]"
                  >
                    <span v-if="raffleBuying === tier.id">Buying…</span>
                    <span v-else-if="!isLoggedIn">Log in</span>
                    <span v-else-if="userRaffleTokens < tier.cost">Need {{ (tier.cost - Math.floor(userRaffleTokens)).toLocaleString() }} more RT</span>
                    <span v-else>Buy</span>
                  </button>
                </div>
              </div>
            </div>

            <div v-else class="raffle-loading">Loading raffle…</div>
          </div>

          <!-- Admin Tab -->
          <div v-else-if="activeTab === 'admin'" class="admin-container">
            <h2 class="admin-heading">Admin Panel</h2>

            <!-- Raffle Section -->
            <div class="admin-card">
              <h3 class="admin-card-title">Raffle — Actian Mystery Swag</h3>
              <div class="admin-raffle-status-row">
                <div v-if="raffleData && raffleData.raffle_closed" class="admin-closed-badge">Raffle Closed</div>
                <div v-else class="admin-open-badge">Raffle Open</div>
                <span class="admin-draws-count" v-if="adminRaffleWinners.length">{{ adminRaffleWinners.length }} winner(s) drawn</span>
              </div>

              <!-- All drawn winners -->
              <div v-if="adminRaffleWinners.length" class="admin-winners-list">
                <div v-for="w in adminRaffleWinners" :key="w.draw_number" class="admin-winner-box">
                  <div class="admin-winner-label">Draw #{{ w.draw_number }}</div>
                  <div class="admin-winner-name">{{ w.username }}</div>
                  <div class="admin-winner-email">{{ w.email }}</div>
                  <div class="admin-winner-meta">{{ w.tickets }} ticket(s) &middot; drawn {{ w.drawn_at ? w.drawn_at.slice(0,19).replace('T',' ') : '' }} UTC</div>
                </div>
              </div>

              <div v-if="adminRaffleError" class="admin-error">{{ adminRaffleError }}</div>

              <div class="admin-raffle-btn-row">
                <button
                  class="admin-btn admin-btn-primary"
                  :disabled="adminRaffleRunning || (raffleData && raffleData.raffle_closed)"
                  @click="adminRunRaffle"
                >
                  <span v-if="adminRaffleRunning">Drawing…</span>
                  <span v-else-if="raffleData && raffleData.raffle_closed">Raffle Closed</span>
                  <span v-else>Draw Winner{{ adminRaffleWinners.length ? ' Again' : '' }}</span>
                </button>

                <button
                  v-if="!(raffleData && raffleData.raffle_closed)"
                  class="admin-btn admin-btn-danger"
                  :disabled="adminRaffleClosing"
                  @click="adminCloseRaffle"
                >
                  <span v-if="adminRaffleClosing">Closing…</span>
                  <span v-else>Close Raffle</span>
                </button>

                <button
                  v-else
                  class="admin-btn admin-btn-outline"
                  :disabled="adminRaffleClosing"
                  @click="adminOpenRaffle"
                >
                  <span v-if="adminRaffleClosing">Opening…</span>
                  <span v-else>Reopen Raffle</span>
                </button>
              </div>
            </div>

            <!-- Users Section -->
            <div class="admin-card">
              <h3 class="admin-card-title">All Users ({{ adminUsers.length }})</h3>
              <div v-if="adminUsersLoading" class="admin-card-hint">Loading…</div>
              <div v-else-if="adminUsers.length === 0" class="admin-card-hint">No users found.</div>
              <div v-else class="admin-table-wrap">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>Username</th>
                      <th>Email</th>
                      <th>Balance</th>
                      <th>Raffle Tokens</th>
                      <th>Joined</th>
                      <th>Last Login</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="u in adminUsers" :key="u.id">
                      <td class="admin-td-bold">{{ u.username }}</td>
                      <td>{{ u.email }}</td>
                      <td class="admin-td-num">{{ u.balance.toFixed(2) }}</td>
                      <td class="admin-td-num">{{ u.raffle_tokens.toFixed(0) }}</td>
                      <td class="admin-td-muted">{{ u.created_at ? u.created_at.slice(0,10) : '—' }}</td>
                      <td class="admin-td-muted">{{ u.last_login ? u.last_login.slice(0,16).replace('T',' ') : '—' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Positions Section -->
            <div class="admin-card">
              <h3 class="admin-card-title">Active Predictions ({{ adminPositions.length }})</h3>
              <div v-if="adminPositionsLoading" class="admin-card-hint">Loading…</div>
              <div v-else-if="adminPositions.length === 0" class="admin-card-hint">No active predictions.</div>
              <div v-else class="admin-table-wrap">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>User</th>
                      <th>Matchup</th>
                      <th>Sport</th>
                      <th>Date</th>
                      <th>Home Shares</th>
                      <th>Away Shares</th>
                      <th>Avg Home Price</th>
                      <th>Avg Away Price</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="p in adminPositions" :key="p.id">
                      <td class="admin-td-bold">{{ p.username }}</td>
                      <td>{{ p.home_team }} vs {{ p.away_team }}</td>
                      <td><span class="sport-badge">{{ p.sport }}</span></td>
                      <td class="admin-td-muted">{{ p.game_date }}</td>
                      <td class="admin-td-num">{{ p.home_shares > 0 ? p.home_shares.toFixed(2) : '—' }}</td>
                      <td class="admin-td-num">{{ p.away_shares > 0 ? p.away_shares.toFixed(2) : '—' }}</td>
                      <td class="admin-td-num">{{ p.home_shares > 0 ? p.avg_home_price.toFixed(1) + '¢' : '—' }}</td>
                      <td class="admin-td-num">{{ p.away_shares > 0 ? p.avg_away_price.toFixed(1) + '¢' : '—' }}</td>
                      <td><span :class="['status-badge', 'status-' + p.market_status]">{{ p.market_status }}</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Settle Game Section -->
            <div class="admin-card">
              <h3 class="admin-card-title">Settle Game</h3>
              <p class="admin-card-hint">Enter final scores to settle a market and pay out winners.</p>
              <div class="admin-settle-form">
                <div class="admin-form-row">
                  <label class="admin-label">Market</label>
                  <select v-model="adminSettleMarketId" class="admin-select">
                    <option value="">— select a market —</option>
                    <option v-for="m in adminAllMarkets" :key="m.market_id" :value="m.market_id">
                      {{ m.home_team }} vs {{ m.away_team }} ({{ m.game_date }}) [{{ m.status }}]
                    </option>
                  </select>
                </div>
                <div class="admin-form-scores" v-if="adminSettleMarketId">
                  <div class="admin-score-field">
                    <label class="admin-label">{{ adminAllMarkets.find(m=>m.market_id===adminSettleMarketId)?.home_team || 'Home' }} Score</label>
                    <input type="number" v-model.number="adminSettleHomeScore" min="0" class="admin-score-input" placeholder="0">
                  </div>
                  <div class="admin-score-sep">–</div>
                  <div class="admin-score-field">
                    <label class="admin-label">{{ adminAllMarkets.find(m=>m.market_id===adminSettleMarketId)?.away_team || 'Away' }} Score</label>
                    <input type="number" v-model.number="adminSettleAwayScore" min="0" class="admin-score-input" placeholder="0">
                  </div>
                </div>
                <!-- Score Credibility Check -->
                <div v-if="adminScoreCheckLoading" class="score-check-panel score-check-loading">Checking score credibility…</div>
                <div v-if="adminScoreCheck && !adminScoreCheckLoading" :class="['score-check-panel', 'score-check-' + adminScoreCheck.severity]">
                  <div class="score-check-header">
                    <span class="score-check-icon">{{ adminScoreCheck.severity === 'ok' ? '✓' : adminScoreCheck.severity === 'warning' ? '⚠' : '🚨' }}</span>
                    <span class="score-check-title">{{ adminScoreCheck.severity === 'ok' ? 'Score looks credible' : adminScoreCheck.severity === 'warning' ? 'Minor anomaly detected' : 'Suspicious score' }}</span>
                    <span class="score-check-prob">{{ adminScoreCheck.home_team }} {{ (adminScoreCheck.elo_win_prob * 100).toFixed(0) }}% win prob</span>
                  </div>
                  <div class="score-check-meta">
                    Expected: {{ adminScoreCheck.expected_margin > 0 ? adminScoreCheck.home_team : adminScoreCheck.away_team }} by {{ Math.abs(adminScoreCheck.expected_margin).toFixed(0) }} pts
                    &nbsp;·&nbsp;
                    Reported: {{ adminScoreCheck.reported_margin > 0 ? adminScoreCheck.home_team : (adminScoreCheck.reported_margin < 0 ? adminScoreCheck.away_team : 'Tie') }}{{ adminScoreCheck.reported_margin !== 0 ? ' by ' + Math.abs(adminScoreCheck.reported_margin) : '' }}
                  </div>
                  <ul v-if="adminScoreCheck.flags.length" class="score-check-flags">
                    <li v-for="flag in adminScoreCheck.flags" :key="flag">{{ flag }}</li>
                  </ul>
                </div>
                <div v-if="adminSettleResult" class="admin-success">{{ adminSettleResult }}</div>
                <div v-if="adminSettleError" class="admin-error">{{ adminSettleError }}</div>
                <button
                  class="admin-btn admin-btn-primary"
                  :disabled="adminSettleProcessing || !adminSettleMarketId"
                  @click="adminSettleGame"
                >
                  <span v-if="adminSettleProcessing">Settling…</span>
                  <span v-else>Settle Game</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Trade Modal -->
          <div v-if="showTradeModal" class="modal-overlay" @click="closeTradeModal">
            <div class="modal" @click.stop>
              <div class="modal-header">
                <h2>Place Prediction</h2>
                <button class="close-btn" @click="closeTradeModal">×</button>
              </div>
              
              <div class="modal-body">
                <div class="market-summary">
                  <h3>{{ selectedMarket.home_team }} vs {{ selectedMarket.away_team }}</h3>
                  <p class="game-time">{{ formatGameTime(selectedMarket.game_date, selectedMarket.game_time) }}</p>
                </div>

                <div class="trade-form">
                  <div class="form-group">
                    <label>Predict Winner</label>
                    <div class="outcome-selector">
                      <button 
                        :class="['outcome-option', { active: tradeOutcome === 'home' }]"
                        @click="tradeOutcome = 'home'"
                      >
                        <div class="team">{{ selectedMarket.home_team }}</div>
                        <div class="elo-badge" v-if="selectedMarket.home_elo != null">Elo {{ selectedMarket.home_elo }}</div>
                        <div class="price">{{ selectedMarket.home_price.toFixed(1) }}¢</div>
                      </button>
                      <button 
                        :class="['outcome-option', { active: tradeOutcome === 'away' }]"
                        @click="tradeOutcome = 'away'"
                      >
                        <div class="team">{{ selectedMarket.away_team }}</div>
                        <div class="elo-badge" v-if="selectedMarket.away_elo != null">Elo {{ selectedMarket.away_elo }}</div>
                        <div class="price">{{ selectedMarket.away_price.toFixed(1) }}¢</div>
                      </button>
                    </div>
                  </div>

                  <div class="form-group">
                    <label>Amount (tokens)</label>
                    <input 
                      type="number" 
                      v-model.number="tradeAmount"
                      min="1"
                      :max="userBalance"
                      step="10"
                      class="amount-input"
                    >
                    <div class="quick-amounts">
                      <button @click="tradeAmount = 100" class="quick-btn">100</button>
                      <button @click="tradeAmount = 500" class="quick-btn">500</button>
                      <button @click="tradeAmount = 1000" class="quick-btn">1000</button>
                      <button @click="tradeAmount = userBalance" class="quick-btn">Max</button>
                    </div>
                  </div>

                  <div class="trade-summary">
                    <p>You'll receive approximately <strong>{{ (tradeAmount / (tradeOutcome === 'home' ? selectedMarket.home_price : selectedMarket.away_price) * 100).toFixed(2) }}</strong> shares</p>
                    <p class="potential">Potential return: <strong>{{ formatTokens(tradeAmount / (tradeOutcome === 'home' ? selectedMarket.home_price : selectedMarket.away_price) * 100) }}</strong></p>
                  </div>

                  <div v-if="tradeResult" :class="['trade-result', tradeResult.success ? 'success' : 'error']">
                    {{ tradeResult.message }}
                  </div>

                  <button 
                    class="submit-btn" 
                    @click="executeTrade"
                    :disabled="tradeProcessing || tradeAmount <= 0 || tradeAmount > userBalance"
                  >
                    <span v-if="tradeProcessing">Processing...</span>
                    <span v-else>Confirm Prediction</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Sell Modal -->
          <div v-if="showSellModal" class="modal-overlay" @click="closeSellModal">
            <div class="modal" @click.stop>
              <div class="modal-header">
                <h2>Sell Shares</h2>
                <button class="close-btn" @click="closeSellModal">×</button>
              </div>
              <div class="modal-body" v-if="sellPosition && sellMarket">
                <div class="market-summary">
                  <h3>{{ sellMarket.home_team }} vs {{ sellMarket.away_team }}</h3>
                  <p class="game-time">Selling: <strong>{{ sellOutcome === 'home' ? sellMarket.home_team : sellMarket.away_team }}</strong> shares</p>
                </div>
                <div class="trade-form">
                  <div class="form-group">
                    <label>Shares to Sell</label>
                    <input
                      type="number"
                      v-model.number="sellShares"
                      min="0.0001"
                      :max="sellOutcome === 'home' ? sellPosition.home_shares : sellPosition.away_shares"
                      step="0.01"
                      class="amount-input"
                      @input="updateSellPreview"
                    >
                    <div class="quick-amounts">
                      <button @click="sellShares = parseFloat(((sellOutcome === 'home' ? sellPosition.home_shares : sellPosition.away_shares) * 0.25).toFixed(4)); updateSellPreview()" class="quick-btn">25%</button>
                      <button @click="sellShares = parseFloat(((sellOutcome === 'home' ? sellPosition.home_shares : sellPosition.away_shares) * 0.5).toFixed(4)); updateSellPreview()" class="quick-btn">50%</button>
                      <button @click="sellShares = parseFloat(((sellOutcome === 'home' ? sellPosition.home_shares : sellPosition.away_shares) * 0.75).toFixed(4)); updateSellPreview()" class="quick-btn">75%</button>
                      <button @click="sellShares = parseFloat((sellOutcome === 'home' ? sellPosition.home_shares : sellPosition.away_shares).toFixed(4)); updateSellPreview()" class="quick-btn">All</button>
                    </div>
                  </div>
                  <div class="trade-summary" v-if="sellPreview !== null">
                    <p>You will receive approximately <strong>{{ sellPreview.toFixed(2) }} 🪙</strong></p>
                  </div>
                  <div v-if="sellResult" :class="['trade-result', sellResult.success ? 'success' : 'error']">
                    {{ sellResult.message }}
                  </div>
                  <button
                    class="submit-btn"
                    @click="executeSell"
                    :disabled="sellProcessing || sellShares <= 0"
                  >
                    <span v-if="sellProcessing">Processing...</span>
                    <span v-else>Confirm Sell</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Price Chart Modal -->
          <div v-if="showPriceChart" class="modal-overlay" @click="closePriceChart">
            <div class="modal chart-modal" @click.stop>
              <div class="modal-header">
                <h2>📈 Price History</h2>
                <button class="close-btn" @click="closePriceChart">×</button>
              </div>
              <div class="modal-body">
                <div class="market-summary" v-if="selectedMarket">
                  <h3>{{ selectedMarket.home_team }} vs {{ selectedMarket.away_team }}</h3>
                  <p class="game-time">{{ formatGameTime(selectedMarket.game_date, selectedMarket.game_time) }}</p>
                </div>
                <div class="chart-view-btns">
                  <button :class="['chart-view-btn', { active: chartView === '1h' }]" @click="setChartView('1h')">1H</button>
                  <button :class="['chart-view-btn', { active: chartView === '1d' }]" @click="setChartView('1d')">1D</button>
                  <button :class="['chart-view-btn', { active: chartView === '1w' }]" @click="setChartView('1w')">1W</button>
                </div>
                <div v-show="priceChartData === null" class="chart-loading">Loading history...</div>
                <div v-show="priceChartData !== null && priceChartData.length === 0" class="chart-loading">Could not load price history.</div>
                <div v-show="priceChartData !== null && priceChartData.length > 0" class="chart-container">
                  <canvas ref="priceChartCanvasRef"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Expanded Game View Modal -->
          <div v-if="showExpandedView" class="modal-overlay" @click="closeExpandedView">
            <div class="expanded-game-modal" @click.stop>
              <div class="expanded-header">
                <div class="expanded-title">
                  <span class="sport-badge">{{ expandedMarket.sport }}</span>
                  <h2>{{ expandedMarket.home_team }} vs {{ expandedMarket.away_team }}</h2>
                  <span class="status-badge" :class="getStatusColor(expandedMarket.status)">
                    {{ getStatusText(expandedMarket.status) }}
                  </span>
                </div>
                <button class="close-btn" @click="closeExpandedView">×</button>
              </div>

              <div class="expanded-body">
                <!-- Top Section: Game Info -->
                <div class="expanded-info-section">
                  <div class="game-details">
                    <div class="info-item">
                      <span class="info-label">When</span>
                      <span class="info-value">{{ formatGameTime(expandedMarket.game_date, expandedMarket.game_time) }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">📊 Volume:</span>
                      <span class="info-value">{{ formatTokens(expandedMarket.total_volume) }}</span>
                    </div>
                    <div v-if="expandedMarket.status === 'settled'" class="info-item">
                      <span class="info-label">Winner:</span>
                      <span class="info-value">
                        {{ expandedMarket.winner === 'home' ? expandedMarket.home_team : expandedMarket.away_team }}
                      </span>
                    </div>
                  </div>

                  <div class="current-odds">
                    <div class="odds-card">
                      <div class="team-name">{{ expandedMarket.home_team }}</div>
                      <div class="elo-badge" v-if="expandedMarket.home_elo != null">Elo {{ expandedMarket.home_elo }}</div>
                      <div class="price-large">{{ expandedMarket.home_price.toFixed(1) }}¢</div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="odds-card">
                      <div class="team-name">{{ expandedMarket.away_team }}</div>
                      <div class="elo-badge" v-if="expandedMarket.away_elo != null">Elo {{ expandedMarket.away_elo }}</div>
                      <div class="price-large">{{ expandedMarket.away_price.toFixed(1) }}¢</div>
                    </div>
                  </div>
                </div>

                <!-- Bottom Section: Chart + Trading (Left) and Chat (Right) -->
                <div class="expanded-content-grid">
                  <!-- Left: Chart and Trading -->
                  <div class="expanded-chart-section">
                    <div class="section-header">
                      <h3>📈 Price History</h3>
                      <div class="chart-view-btns">
                        <button :class="['chart-view-btn', { active: expandedChartView === '1h' }]" @click="changeExpandedChartView('1h')">1H</button>
                        <button :class="['chart-view-btn', { active: expandedChartView === '1d' }]" @click="changeExpandedChartView('1d')">1D</button>
                        <button :class="['chart-view-btn', { active: expandedChartView === '1w' }]" @click="changeExpandedChartView('1w')">1W</button>
                      </div>
                    </div>
                    <div class="chart-container-expanded">
                      <canvas ref="expandedChartCanvasRef"></canvas>
                    </div>

                    <!-- Trading Options -->
                    <div v-if="expandedMarket.status === 'open'" class="trading-section">
                      <h4>Buy Shares</h4>
                      <div class="trade-buttons">
                        <button class="trade-btn buy-home" @click="buyFromExpandedView('home')">
                          Buy {{ expandedMarket.home_team }}
                        </button>
                        <button class="trade-btn buy-away" @click="buyFromExpandedView('away')">
                          Buy {{ expandedMarket.away_team }}
                        </button>
                      </div>
                      
                      <!-- Sell Options - only show if user has shares -->
                      <div v-if="isLoggedIn && expandedMarketPosition && (expandedMarketPosition.home_shares > 0 || expandedMarketPosition.away_shares > 0)" class="sell-options">
                        <h4>Sell Shares</h4>
                        <div class="trade-buttons">
                          <button v-if="expandedMarketPosition.home_shares > 0" class="trade-btn sell-home" @click="sellFromExpandedView('home')">
                            Sell {{ expandedMarket.home_team }} ({{ expandedMarketPosition.home_shares.toFixed(2) }})
                          </button>
                          <button v-if="expandedMarketPosition.away_shares > 0" class="trade-btn sell-away" @click="sellFromExpandedView('away')">
                            Sell {{ expandedMarket.away_team }} ({{ expandedMarketPosition.away_shares.toFixed(2) }})
                          </button>
                        </div>
                      </div>
                    </div>
                    <div v-else-if="expandedMarket.status === 'closed'" class="trading-section">
                      <p class="status-message">🔒 Trading is closed for this market</p>
                    </div>
                    <div v-else-if="expandedMarket.status === 'settled'" class="trading-section">
                      <template v-if="expandedMarket.winner === 'push'">
                        <p class="status-message">Voided</p>
                      </template>
                      <template v-else>
                        <p class="status-message">Market has been settled</p>
                      </template>
                    </div>
                  </div>

                  <!-- Right: Chat -->
                  <div class="expanded-chat-section">
                    <div class="section-header">
                      <h3>💬 Discussion</h3>
                      <span v-if="expandedMarket.status === 'settled'" class="chat-closed-badge">Closed</span>
                    </div>
                    
                    <div class="chat-messages">
                      <div v-if="chatLoading" class="chat-loading">Loading messages...</div>
                      <div v-else-if="chatMessages.length === 0" class="no-messages">
                        <p>No messages yet. Be the first to comment!</p>
                      </div>
                      <div v-else>
                        <div v-for="msg in chatMessages" :key="msg.message_id"
                             :class="['chat-message', msg.message_type === 'score_report' ? 'score-report-msg' : '']">
                          <template v-if="msg.message_type === 'score_report'">
                            <div class="score-report-label">📊 Score Update</div>
                            <div class="score-report-scoreboard">
                              <div class="srb-row">
                                <span class="srb-team-name">{{ msg.message.split(' \u2013 ')[0]?.split(' ').slice(0,-1).join(' ') }}</span>
                                <span class="srb-score">{{ msg.message.split(' \u2013 ')[0]?.split(' ').at(-1) }}</span>
                              </div>
                              <div class="srb-divider"></div>
                              <div class="srb-row">
                                <span class="srb-team-name">{{ msg.message.split(' \u2013 ')[1]?.split(' ').slice(0,-1).join(' ') }}</span>
                                <span class="srb-score">{{ msg.message.split(' \u2013 ')[1]?.split(' ').at(-1) }}</span>
                              </div>
                            </div>
                            <div class="score-report-footer">
                              <div class="score-report-votes">
                                <button @click.stop="voteOnScoreReport(msg.message_id, 'up')"
                                        :class="['vote-btn', 'vote-up', { active: msg.voters && user && msg.voters[user.username] === 'up' }]"
                                        :disabled="!isLoggedIn"
                                        :title="isLoggedIn ? 'Upvote' : 'Log in to vote'">
                                  👍 {{ msg.upvotes || 0 }}
                                </button>
                                <button @click.stop="voteOnScoreReport(msg.message_id, 'down')"
                                        :class="['vote-btn', 'vote-down', { active: msg.voters && user && msg.voters[user.username] === 'down' }]"
                                        :disabled="!isLoggedIn"
                                        :title="isLoggedIn ? 'Downvote' : 'Log in to vote'">
                                  👎 {{ msg.downvotes || 0 }}
                                </button>
                              </div>
                              <span class="score-report-meta">by {{ msg.username }} · {{ new Date(msg.timestamp).toLocaleTimeString() }}</span>
                            </div>
                          </template>
                          <template v-else>
                            <div class="message-header">
                              <span class="message-username">{{ msg.username }}</span>
                              <span class="message-time">{{ new Date(msg.timestamp).toLocaleString() }}</span>
                            </div>
                            <div class="message-content">{{ msg.message }}</div>
                          </template>
                        </div>
                      </div>
                    </div>

                    <div v-if="expandedMarket.status !== 'settled'" class="chat-input-section">
                      <div v-if="!isLoggedIn" class="chat-login-prompt">
                        <p>Please <a href="#" @click.prevent="openAuthModal('login')">login</a> to chat</p>
                      </div>
                      <div v-else>
                        <div class="chat-input-container">
                          <input 
                            v-model="chatMessage" 
                            @keyup.enter="sendChatMessage"
                            type="text" 
                            placeholder="Type your message..."
                            class="chat-input"
                            maxlength="500"
                          >
                          <button @click="sendChatMessage" class="send-btn" :disabled="!chatMessage.trim()">Send</button>
                          <button @click="showScoreReport = !showScoreReport" class="score-report-toggle-btn" title="Report current score">📊</button>
                        </div>
                        <div v-if="showScoreReport" class="score-report-form">
                          <div class="score-report-row">
                            <span class="score-team-label">{{ expandedMarket.home_team }}</span>
                            <input v-model="scoreReportHome" type="number" min="0" placeholder="0" class="score-input">
                            <span class="score-sep">–</span>
                            <input v-model="scoreReportAway" type="number" min="0" placeholder="0" class="score-input">
                            <span class="score-team-label">{{ expandedMarket.away_team }}</span>
                          </div>
                          <div v-if="userScoreCheckLoading" class="score-check-panel score-check-loading" style="margin-bottom:6px">Checking score…</div>
                          <div v-if="userScoreCheck && !userScoreCheckLoading" :class="['score-check-panel', 'score-check-' + userScoreCheck.severity]" style="margin-bottom:6px">
                            <div class="score-check-header">
                              <span>{{ userScoreCheck.severity === 'ok' ? '✓' : userScoreCheck.severity === 'warning' ? '⚠' : '🚫' }}</span>
                              <span>{{ userScoreCheck.severity === 'ok' ? 'Score looks valid' : userScoreCheck.severity === 'warning' ? 'Unusual score — confirm to post' : 'Score blocked' }}</span>
                            </div>
                            <ul v-if="userScoreCheck.flags.length" class="score-check-flags">
                              <li v-for="flag in userScoreCheck.flags" :key="flag">{{ flag }}</li>
                            </ul>
                          </div>
                          <div class="score-report-actions">
                            <button @click="sendScoreReport"
                              :class="['submit-score-btn', userScoreCheckConfirmed ? 'submit-score-btn-warn' : '']"
                              :disabled="scoreReportLoading || scoreReportHome === '' || scoreReportAway === '' || userScoreCheck?.severity === 'alert'">
                              <span v-if="scoreReportLoading">Posting…</span>
                              <span v-else-if="userScoreCheckConfirmed">⚠ Post Anyway?</span>
                              <span v-else>Post Score</span>
                            </button>
                            <button @click="showScoreReport = false; userScoreCheckConfirmed = false" class="cancel-score-btn">Cancel</button>
                          </div>
                        </div>
                      </div>
                      <div v-if="chatError" class="chat-error">{{ chatError }}</div>
                    </div>
                    <div v-else class="chat-closed-message">
                      <p>Chat is closed for settled markets</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Auth Modal -->
          <div v-if="showAuthModal" class="modal-overlay" @click="showAuthModal = false">
            <div class="modal auth-modal" @click.stop>
              <div class="modal-header">
                <h2>{{ authMode === 'login' ? 'Login' : 'Register' }}</h2>
                <button class="close-btn" @click="showAuthModal = false">×</button>
              </div>
              
              <div class="modal-body">
                <div class="auth-form">
                  <div class="form-group">
                    <label>Username</label>
                    <input 
                      type="text" 
                      v-model="authUsername"
                      placeholder="Enter username"
                      class="form-input"
                      @keyup.enter="authMode === 'login' ? login() : register()"
                    >
                  </div>

                  <div v-if="authMode === 'register'" class="form-group">
                    <label>Email</label>
                    <input 
                      type="email" 
                      v-model="authEmail"
                      placeholder="Enter email"
                      class="form-input"
                      @keyup.enter="register()"
                    >
                  </div>

                  <div class="form-group">
                    <label>Password</label>
                    <input 
                      type="password" 
                      v-model="authPassword"
                      placeholder="Enter password"
                      class="form-input"
                      @keyup.enter="authMode === 'login' ? login() : register()"
                    >
                  </div>

                  <div v-if="authError" class="auth-error">
                    {{ authError }}
                  </div>

                  <button 
                    class="submit-btn" 
                    @click="authMode === 'login' ? login() : register()"
                    :disabled="authProcessing || !authUsername || !authPassword || (authMode === 'register' && !authEmail)"
                  >
                    <span v-if="authProcessing">Processing...</span>
                    <span v-else>{{ authMode === 'login' ? 'Login' : 'Create Account' }}</span>
                  </button>

                  <div class="auth-switch">
                    <a href="#" @click.prevent="authMode = authMode === 'login' ? 'register' : 'login'">
                      {{ authMode === 'login' ? 'Need an account? Register' : 'Already have an account? Login' }}
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `
    }).mount('#app');
  </script>

  <style>
    /* ============================================================
       DESIGN SYSTEM
       Accent:  #9370DB  (single blue)
       Text:    #0f172a / #374151 / #6b7280 / #9ca3af
       Surface: #ffffff / #f8fafc
       Border:  #e2e8f0
       BG:      #f1f5f9
       Radius:  6px cards, 4px controls
       Shadow:  very subtle
    ============================================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, sans-serif;
      background: #f1f5f9;
      min-height: 100vh;
      padding: 20px;
      color: #374151;
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* ── Navbar ─────────────────────────────────── */
    .navbar {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      margin-bottom: 0;
    }

    .navbar-inner {
      display: flex;
      align-items: stretch;
      height: 56px;
      padding: 0 20px;
    }

    .navbar-brand {
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding-right: 20px;
      border-right: 1px solid #e2e8f0;
      margin-right: 4px;
      white-space: nowrap;
      gap: 2px;
    }

    .brand-name {
      font-size: 1.1rem;
      font-weight: 800;
      color: #0f172a;
      letter-spacing: -0.02em;
      line-height: 1.1;
    }

    .brand-sub {
      font-size: 0.6rem;
      color: #9ca3af;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .navbar-tabs {
      display: flex;
      align-items: stretch;
      flex: 1;
    }

    .nav-tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 18px;
      border: none;
      border-bottom: 3px solid transparent;
      background: transparent;
      font-size: 0.68rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      margin-bottom: -1px;
      white-space: nowrap;
    }

    .nav-tab:hover { color: #374151; }

    .nav-tab.active {
      color: #9370DB;
      border-bottom-color: #9370DB;
    }

    .nav-tab.nav-tab-admin.active {
      color: #0f172a;
      border-bottom-color: #0f172a;
    }

    .navbar-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .wallet {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .user-info {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .username {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
    }

    .auth-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-login, .btn-register, .btn-logout {
      padding: 7px 16px;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }

    .btn-login {
      background: transparent;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-login:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }

    .btn-register {
      background: #9370DB;
      color: #ffffff;
      border: 1px solid #9370DB;
    }

    .btn-register:hover {
      background: #7B2FBE;
      border-color: #7B2FBE;
    }

    .btn-logout {
      background: transparent;
      color: #6b7280;
      border: 1px solid #e2e8f0;
      font-size: 0.8rem;
      padding: 5px 12px;
    }

    .btn-logout:hover {
      background: #fef2f2;
      color: #dc2626;
      border-color: #fca5a5;
    }

    .balance, .total-value {
      text-align: right;
    }

    .label {
      display: block;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .amount {
      display: block;
      font-size: 1.25rem;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: -0.02em;
    }

    /* ── Loading & States ────────────────────────── */
    .loading, .error, .no-markets, .no-positions {
      background: #ffffff;
      padding: 48px 32px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      text-align: center;
      color: #6b7280;
    }

    .spinner {
      border: 2px solid #e2e8f0;
      border-top: 2px solid #9370DB;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ── Subnav (date filter) ─────────────────────── */
    .subnav {
      display: flex;
      margin-bottom: 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-top: none;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
    }

    .subnav-dropdown-wrap {
      display: none;
      margin-bottom: 16px;
    }

    .date-dropdown {
      width: 100%;
      padding: 10px 14px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-top: none;
      border-radius: 0 0 8px 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239370DB' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }

    .date-chip {
      flex: 1;
      padding: 8px 6px;
      background: transparent;
      border: none;
      border-right: 1px solid #e2e8f0;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      cursor: pointer;
      transition: background 0.12s, color 0.12s;
      white-space: nowrap;
      text-align: center;
    }

    .date-chip:last-child {
      border-right: none;
    }

    .date-chip:hover {
      background: #f1f5f9;
      color: #374151;
    }

    .date-chip.active {
      background: #9370DB;
      color: #ffffff;
      font-weight: 700;
    }

    /* ── Markets Container ───────────────────────── */
    .markets-container {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .markets-content {
      flex: 1;
      min-width: 0;
    }

    /* ── Sport Sidebar ───────────────────────────── */
    .sport-sidebar {
      width: 176px;
      flex-shrink: 0;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 16px;
      position: sticky;
      top: 16px;
      max-height: calc(100vh - 32px);
      overflow-y: auto;
    }

    .sidebar-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .sport-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sport-btn {
      padding: 7px 10px;
      background: transparent;
      border: none;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: background 0.12s, color 0.12s;
      text-align: left;
    }

    .sport-btn:hover {
      background: #f1f5f9;
    }

    .sport-btn.active {
      background: #f5f0ff;
      color: #9370DB;
      font-weight: 600;
    }

    /* ── Market Section / Grid ───────────────────── */
    .market-section {
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #6b7280;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    .markets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 12px;
    }

    /* ── Market Card ─────────────────────────────── */
    .market-card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 16px;
      transition: border-color 0.12s, box-shadow 0.12s;
    }

    .market-card:hover {
      border-color: #cbd5e1;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    .market-card.clickable {
      cursor: pointer;
    }

    .market-card.clickable:hover {
      border-color: #9370DB;
    }

    .market-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .sport-badge {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 3px;
      padding: 2px 8px;
    }

    .status-badge {
      font-size: 0.7rem;
      font-weight: 700;
      border-radius: 3px;
      padding: 2px 8px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .status-open {
      background: #f0fdf4;
      color: #16a34a;
      border: 1px solid #bbf7d0;
    }

    .status-closed {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .status-settled {
      background: #f0f9ff;
      color: #0369a1;
      border: 1px solid #bae6fd;
    }

    .matchup h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .game-info {
      display: flex;
      gap: 12px;
      font-size: 0.78rem;
      color: #6b7280;
      margin-bottom: 14px;
    }

    .odds-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }

    .odds-section.disabled {
      opacity: 0.5;
    }

    .outcome-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      padding: 12px;
      text-align: center;
    }

    .outcome-card.home {
      border-left: 3px solid #9370DB;
    }

    .outcome-card.away {
      border-left: 3px solid #64748b;
    }

    .team-name {
      font-weight: 600;
      font-size: 0.8rem;
      color: #374151;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .elo-badge {
      font-size: 0.68rem;
      font-weight: 600;
      color: #6b7280;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 3px;
      padding: 1px 5px;
      margin-bottom: 6px;
      display: inline-block;
    }

    .price {
      font-size: 1.375rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .buy-btn {
      width: 100%;
      padding: 7px;
      background: #9370DB;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.12s;
    }

    .buy-btn:hover {
      background: #7B2FBE;
    }

    .market-stats {
      font-size: 0.75rem;
      color: #9ca3af;
      padding-top: 10px;
      border-top: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }

    .expand-hint {
      font-size: 0.75rem;
      color: #9370DB;
      font-weight: 500;
    }

    .settlement-info {
      margin-top: 10px;
      text-align: center;
    }

    .winner-banner {
      padding: 5px 12px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.8rem;
      text-align: center;
      display: inline-block;
    }

    .winner-banner.home {
      background: #ede9fe;
      color: #6d28d9;
      border: 1px solid #c4b5fd;
    }

    .winner-banner.away {
      background: #e2e8f0;
      color: #334155;
      border: 1px solid #cbd5e1;
    }

    .winner-banner.push {
      background: #e5e7eb;
      color: #4b5563;
      border: 1px solid #d1d5db;
    }

    .trophy { margin-right: 6px; }

    .final-score {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 1.25rem;
      font-weight: 700;
    }

    .final-score .score {
      padding: 4px 12px;
      border-radius: 4px;
      background: #f1f5f9;
      color: #374151;
    }

    .final-score .score.winner {
      background: #9370DB;
      color: #ffffff;
    }

    .final-score .score.loser {
      background: #f1f5f9;
      color: #9ca3af;
    }

    .final-score .score-separator {
      color: #d1d5db;
    }

    /* ── Portfolio ───────────────────────────────── */
    .portfolio-container {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 24px;
      min-height: 60vh;
    }

    .positions-section {
      margin-bottom: 32px;
    }

    .positions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    .position-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 20px;
      border-left: 4px solid #9370DB;
    }

    .position-card.settled {
      border-left-color: #16a34a;
    }

    .position-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 14px;
    }

    .position-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .shares-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      color: #374151;
      padding: 4px 0;
      border-bottom: 1px solid #f1f5f9;
    }

    .shares-info:last-of-type { border-bottom: none; }

    .shares-info .label { text-transform: none; letter-spacing: 0; font-size: 0.85rem; }

    .shares-info.highlight {
      font-weight: 700;
      font-size: 0.9rem;
      color: #9370DB;
    }

    .sell-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .sell-btn {
      flex: 1;
      padding: 6px 12px;
      background: transparent;
      color: #dc2626;
      border: 1px solid #fca5a5;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.12s;
      min-width: 100px;
    }

    .sell-btn:hover {
      background: #fef2f2;
    }

    /* ── Charts ──────────────────────────────────── */
    .chart-btn {
      background: transparent;
      border: 1px solid #d1d5db;
      color: #374151;
      border-radius: 4px;
      padding: 3px 10px;
      font-size: 0.78rem;
      font-weight: 500;
      cursor: pointer;
      transition: border-color 0.12s, color 0.12s;
    }

    .chart-btn:hover {
      border-color: #9370DB;
      color: #9370DB;
    }

    .chart-modal {
      max-width: 680px !important;
    }

    .chart-container {
      height: 300px;
      position: relative;
    }

    .chart-loading {
      text-align: center;
      color: #9ca3af;
      padding: 32px 0;
      font-size: 0.875rem;
    }

    .chart-view-btns {
      display: flex;
      gap: 4px;
      justify-content: flex-end;
      margin-bottom: 10px;
    }

    .chart-view-btn {
      padding: 3px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: transparent;
      color: #6b7280;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.12s;
    }

    .chart-view-btn:hover {
      border-color: #9370DB;
      color: #9370DB;
    }

    .chart-view-btn.active {
      background: #9370DB;
      border-color: #9370DB;
      color: #ffffff;
    }

    /* ── Modal ───────────────────────────────────── */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15,23,42,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
    }

    .modal-header h2 {
      font-size: 1rem;
      font-weight: 700;
      color: #0f172a;
    }

    .close-btn {
      background: transparent;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #9ca3af;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.12s, color 0.12s;
      line-height: 1;
    }

    .close-btn:hover {
      background: #f1f5f9;
      color: #374151;
    }

    .modal-body {
      padding: 20px 24px;
    }

    .market-summary {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f1f5f9;
    }

    .market-summary h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 4px;
    }

    .game-time {
      color: #6b7280;
      font-size: 0.8rem;
    }

    .trade-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group label {
      display: block;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .outcome-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .outcome-option {
      padding: 16px 12px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      cursor: pointer;
      transition: border-color 0.12s, background 0.12s;
      text-align: center;
    }

    .outcome-option:hover {
      border-color: #9370DB;
    }

    .outcome-option.active {
      border-color: #9370DB;
      background: #f5f0ff;
    }

    .outcome-option .team {
      font-size: 0.825rem;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 4px;
    }

    .outcome-option .price {
      font-size: 1.25rem;
      font-weight: 700;
      color: #9370DB;
      letter-spacing: -0.02em;
    }

    .amount-input {
      width: 100%;
      padding: 10px 14px;
      font-size: 1.1rem;
      font-weight: 600;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      color: #0f172a;
      transition: border-color 0.12s;
    }

    .amount-input:focus {
      outline: none;
      border-color: #9370DB;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
    }

    .quick-amounts {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .quick-btn {
      flex: 1;
      padding: 6px;
      background: transparent;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      transition: background 0.12s, border-color 0.12s, color 0.12s;
    }

    .quick-btn:hover {
      background: #9370DB;
      border-color: #9370DB;
      color: #ffffff;
    }

    .trade-summary {
      padding: 12px 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 0.875rem;
      color: #374151;
      text-align: center;
    }

    .trade-summary p { margin-bottom: 4px; }
    .trade-summary .potential { font-weight: 700; color: #16a34a; }

    .trade-result {
      padding: 10px 14px;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
      text-align: center;
    }

    .trade-result.success { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
    .trade-result.error   { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }

    .submit-btn {
      width: 100%;
      padding: 12px;
      background: #9370DB;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.12s;
    }

    .submit-btn:hover:not(:disabled) { background: #7B2FBE; }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ── Auth Modal ───────────────────────────────── */
    .auth-modal { max-width: 360px; }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 0.875rem;
      color: #0f172a;
      transition: border-color 0.12s;
    }

    .form-input:focus {
      outline: none;
      border-color: #9370DB;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
    }

    .auth-error {
      padding: 10px 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 4px;
      color: #dc2626;
      font-size: 0.825rem;
    }

    .auth-switch {
      text-align: center;
      padding-top: 8px;
      font-size: 0.825rem;
      color: #6b7280;
    }

    .auth-switch a {
      color: #9370DB;
      text-decoration: none;
      font-weight: 600;
    }

    .auth-switch a:hover { text-decoration: underline; }

    /* ── Responsive ──────────────────────────────── */
    @media (max-width: 768px) {
      /* ── Layout ── */
      body { padding: 6px; }

      /* ── Navbar: 2-row layout ── */
      .navbar-inner {
        flex-direction: column;
        height: auto;
        padding: 0;
      }

      /* Top row: brand + actions */
      .navbar-brand {
        order: 1;
        border-right: none;
        border-bottom: 1px solid #e2e8f0;
        padding: 10px 14px;
        margin-right: 0;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        box-sizing: border-box;
      }

      .navbar-actions {
        order: 1; /* same row as brand via absolute trick below */
      }

      /* Wrap brand and actions in same row */
      .navbar-inner {
        display: grid;
        grid-template-columns: auto 1fr auto;
        grid-template-rows: auto auto;
        padding: 0;
      }

      .navbar-brand {
        grid-column: 1;
        grid-row: 1;
        border-right: none;
        border-bottom: none;
        padding: 10px 14px;
        margin-right: 0;
      }

      .navbar-tabs {
        grid-column: 1 / -1;
        grid-row: 2;
        border-top: 1px solid #e2e8f0;
        height: 40px;
      }

      .navbar-actions {
        grid-column: 3;
        grid-row: 1;
        padding: 0 10px;
        gap: 8px;
      }

      /* Compact user info */
      .user-info { gap: 6px; }

      .balance .label { display: none; }
      .balance .amount { font-size: 0.82rem; font-weight: 700; }

      .username span { display: none; }  /* hide username text, keep logout */

      .btn-logout { padding: 5px 10px; font-size: 0.75rem; }
      .btn-login  { padding: 5px 10px; font-size: 0.75rem; }
      .btn-register { padding: 5px 10px; font-size: 0.75rem; }

      .dark-mode-toggle { width: 32px; height: 18px; }

      /* Tabs */
      .nav-tab { font-size: 0.6rem; letter-spacing: 0.06em; padding: 0 10px; }

      /* Date subnav */
      .subnav-chips { display: none !important; }
      .subnav-dropdown-wrap { display: block; }

      /* Markets layout */
      .markets-container { flex-direction: column; gap: 8px; }

      /* Sport sidebar: horizontal scrolling chip strip */
      .sport-sidebar {
        width: 100%;
        position: static;
        max-height: none;
        padding: 8px 10px;
        border-radius: 6px;
      }
      .sidebar-title { display: none; }
      .sport-list {
        flex-direction: row;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 6px;
        padding-bottom: 2px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      .sport-list::-webkit-scrollbar { display: none; }
      .sport-btn {
        white-space: nowrap;
        flex-shrink: 0;
        padding: 5px 12px;
        border-radius: 20px;
        border: 1px solid #e2e8f0;
        font-size: 0.78rem;
      }
      .sport-btn.active {
        border-color: #9370DB;
      }

      /* Markets grid */
      .markets-grid, .positions-grid {
        grid-template-columns: 1fr;
        max-width: 480px;
        margin-left: auto;
        margin-right: auto;
      }

      /* Market card */
      .market-card { padding: 12px; }
      .market-header { margin-bottom: 8px; }
      .matchup h3 { font-size: 0.84rem; }
      .game-info { font-size: 0.72rem; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
      .odds-section { gap: 6px; margin-bottom: 8px; }
      .outcome-card { padding: 8px; }
      .price { font-size: 1.15rem; margin-bottom: 6px; }
      .team-name { font-size: 0.74rem; }
      .elo-badge { font-size: 0.62rem; }
      .buy-btn { padding: 6px; font-size: 0.75rem; }
      .market-stats { font-size: 0.7rem; }
      .section-title { font-size: 0.7rem; }

      /* Inner tabs (buy/sell in modal) */
      .tabs { padding: 3px; }
      .tab { font-size: 0.8rem; padding: 7px 10px; }
    }

    /* ── Expanded Game Modal ─────────────────────── */
    .expanded-game-modal {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      width: 95%;
      max-width: 1320px;
      max-height: 95vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 16px 48px rgba(0,0,0,0.12);
    }

    .expanded-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 20px;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
    }

    .expanded-title {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .expanded-title h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: #0f172a;
    }

    .expanded-title .sport-badge {
      background: #f1f5f9;
      color: #6b7280;
      border: 1px solid #e2e8f0;
    }

    .expanded-title .status-badge { }

    .expanded-body {
      overflow-y: auto;
      flex: 1;
      padding: 16px 20px;
      background: #f8fafc;
    }

    .expanded-info-section {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      margin-bottom: 14px;
      padding: 14px 16px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
    }

    .game-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .info-label {
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
    }

    .info-value {
      font-size: 0.875rem;
      color: #0f172a;
      font-weight: 600;
    }

    .current-odds {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .odds-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 10px 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      min-width: 110px;
    }

    .odds-card .team-name {
      font-weight: 600;
      font-size: 0.78rem;
      color: #374151;
      text-align: center;
    }

    .price-large {
      font-size: 1.375rem;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: -0.02em;
    }

    .vs-divider {
      font-weight: 700;
      font-size: 0.8rem;
      color: #d1d5db;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .expanded-content-grid {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 14px;
      height: calc(95vh - 320px);
    }

    .expanded-chart-section,
    .expanded-chat-section {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f1f5f9;
    }

    .section-header h3 {
      margin: 0;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
    }

    .chart-container-expanded {
      flex: 1;
      min-height: 160px;
      margin-bottom: 10px;
    }

    .trading-section {
      padding-top: 10px;
      border-top: 1px solid #f1f5f9;
    }

    .trading-section h4 {
      margin: 0 0 8px;
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
    }

    .trade-buttons {
      display: flex;
      gap: 8px;
    }

    .trade-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.825rem;
      cursor: pointer;
      transition: background 0.12s;
    }

    .trade-btn.buy-home {
      background: #9370DB;
      color: #ffffff;
    }

    .trade-btn.buy-home:hover { background: #7B2FBE; }

    .trade-btn.buy-away {
      background: #475569;
      color: #ffffff;
    }

    .trade-btn.buy-away:hover { background: #334155; }

    .trade-btn.sell-home,
    .trade-btn.sell-away {
      background: transparent;
      color: #dc2626;
      border: 1px solid #fca5a5;
    }

    .trade-btn.sell-home:hover,
    .trade-btn.sell-away:hover { background: #fef2f2; }

    .sell-options {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #f1f5f9;
    }

    .sell-options h4 {
      margin: 0 0 8px;
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
    }

    .status-message {
      text-align: center;
      padding: 10px;
      color: #6b7280;
      font-size: 0.825rem;
    }

    /* ── Chat ────────────────────────────────────── */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      padding: 10px;
      background: #f8fafc;
      border-radius: 4px;
      border: 1px solid #f1f5f9;
    }

    .chat-loading, .no-messages {
      text-align: center;
      padding: 16px 10px;
      color: #9ca3af;
      font-size: 0.825rem;
    }

    .chat-message {
      background: #ffffff;
      padding: 7px 10px;
      border: 1px solid #f1f5f9;
      border-radius: 4px;
      margin-bottom: 6px;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3px;
    }

    .message-username {
      font-weight: 700;
      color: #9370DB;
      font-size: 0.78rem;
    }

    .message-time {
      font-size: 0.68rem;
      color: #9ca3af;
    }

    .message-content {
      color: #374151;
      line-height: 1.4;
      word-wrap: break-word;
      font-size: 0.85rem;
    }

    .chat-input-section {
      border-top: 1px solid #f1f5f9;
      padding-top: 10px;
    }

    .chat-login-prompt {
      text-align: center;
      padding: 10px;
      background: #f8fafc;
      border-radius: 4px;
      font-size: 0.825rem;
      color: #6b7280;
    }

    .chat-login-prompt a { color: #9370DB; font-weight: 600; text-decoration: none; }
    .chat-login-prompt a:hover { text-decoration: underline; }

    .chat-input-container { display: flex; gap: 6px; }

    .chat-input {
      flex: 1;
      padding: 7px 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 0.85rem;
      color: #0f172a;
      transition: border-color 0.12s;
    }

    .chat-input:focus {
      outline: none;
      border-color: #9370DB;
    }

    .send-btn {
      padding: 7px 16px;
      background: #9370DB;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.12s;
    }

    .send-btn:hover:not(:disabled) { background: #7B2FBE; }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .chat-error {
      margin-top: 6px;
      padding: 6px 10px;
      background: #fef2f2;
      color: #dc2626;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .chat-closed-badge {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
      padding: 2px 10px;
      border-radius: 3px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .chat-closed-message {
      text-align: center;
      padding: 16px;
      color: #9ca3af;
      font-size: 0.825rem;
    }

    /* ── Score Report ─────────────────────────────── */
    .score-report-msg {
      background: #faf5ff !important;
      border-left: 3px solid #9370DB !important;
      padding: 9px 10px !important;
    }

    .score-report-label {
      font-size: 0.68rem;
      font-weight: 700;
      color: #7c3aed;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }

    .score-report-scoreboard {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-bottom: 6px;
    }

    .srb-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .srb-row:first-child { border-bottom: 1px solid #e9d5ff; }

    .srb-team-name {
      font-size: 0.82rem;
      font-weight: 600;
      color: #1e1b4b;
      flex: 1;
    }

    .srb-score {
      font-size: 1.15rem;
      font-weight: 800;
      color: #6d28d9;
      min-width: 28px;
      text-align: right;
    }

    .srb-divider { display: none; }

    .score-report-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 5px;
      gap: 6px;
    }

    .score-report-meta { font-size: 0.68rem; color: #9ca3af; }

    .score-report-votes { display: flex; gap: 4px; }

    .vote-btn {
      display: flex;
      align-items: center;
      gap: 3px;
      padding: 2px 8px;
      border-radius: 3px;
      border: 1px solid #e2e8f0;
      background: #ffffff;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.12s;
      color: #6b7280;
    }

    .vote-btn:disabled { opacity: 0.5; cursor: default; }
    .vote-btn:not(:disabled):hover { border-color: #9ca3af; background: #f9fafb; }
    .vote-btn.vote-up.active { background: #f0fdf4; border-color: #86efac; color: #16a34a; }
    .vote-btn.vote-down.active { background: #fef2f2; border-color: #fca5a5; color: #dc2626; }

    .score-report-toggle-btn {
      padding: 5px 8px;
      background: #faf5ff;
      border: 1px solid #e9d5ff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      flex-shrink: 0;
      color: #7c3aed;
      transition: background 0.12s;
    }

    .score-report-toggle-btn:hover { background: #f3e8ff; }

    .score-report-form {
      margin-top: 8px;
      padding: 10px;
      background: #faf5ff;
      border: 1px solid #e9d5ff;
      border-radius: 4px;
    }

    .score-report-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .score-team-label {
      font-size: 0.78rem;
      font-weight: 600;
      color: #374151;
      flex: 1;
      min-width: 60px;
    }

    .score-input {
      width: 48px;
      padding: 5px 6px;
      border: 1px solid #e9d5ff;
      border-radius: 4px;
      font-size: 0.95rem;
      font-weight: 700;
      text-align: center;
      background: white;
    }

    .score-input:focus { outline: none; border-color: #9370DB; }

    .score-sep {
      font-weight: 700;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .score-report-actions { display: flex; gap: 6px; }

    .submit-score-btn {
      flex: 1;
      padding: 6px 12px;
      background: #9370DB;
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 700;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.12s;
    }

    .submit-score-btn:hover:not(:disabled) { background: #7B2FBE; }
    .submit-score-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .submit-score-btn-warn { background: #d97706 !important; }
    .submit-score-btn-warn:hover:not(:disabled) { background: #b45309 !important; }

    .cancel-score-btn {
      padding: 6px 12px;
      background: transparent;
      color: #6b7280;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .cancel-score-btn:hover { background: #f9fafb; }

    /* ── Responsive expanded view ─────────────────── */
    @media (max-width: 1024px) {
      .expanded-content-grid { grid-template-columns: 1fr; }
      .expanded-info-section { grid-template-columns: 1fr; }
      .current-odds { justify-content: center; }
    }

    @media (max-width: 768px) {
      .expanded-game-modal { width: 99%; max-height: 96vh; border-radius: 6px; }
      .expanded-header { padding: 10px 12px; }
      .expanded-body { padding: 10px 12px; }
      .expanded-title { flex-wrap: wrap; gap: 6px; }
      .expanded-title h2 { font-size: 0.85rem; }
      .expanded-info-section { grid-template-columns: 1fr; gap: 10px; padding: 10px 12px; }
      .current-odds { flex-wrap: wrap; justify-content: center; }
      .odds-card { min-width: 80px; padding: 8px 10px; }
      /* Remove the fixed height so the stacked sections auto-size */
      .expanded-content-grid { height: auto; }
      .expanded-chart-section { min-height: 260px; }
      .expanded-chat-section { min-height: 200px; max-height: 260px; }
    }

    /* ── Raffle Tab ───────────────────────────────── */
    .raffle-container {
      max-width: 820px;
      margin: 0 auto;
      padding: 24px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      min-height: 60vh;
    }

    .raffle-balance-bar {
      background: #0f172a;
      border-radius: 6px;
      padding: 16px 20px;
      color: white;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .raffle-balance-main { flex: 1; }

    .raffle-sponsor-logo {
      height: 28px;
      width: auto;
      object-fit: contain;
      filter: brightness(0) invert(1);
      opacity: 0.7;
      flex-shrink: 0;
    }

    .raffle-balance-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .raffle-balance-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.7;
    }

    .raffle-balance-amount {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .raffle-balance-hint {
      font-size: 0.75rem;
      opacity: 0.5;
      margin: 0;
    }

    .raffle-login-prompt {
      text-align: center;
      padding: 12px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .raffle-login-prompt a { color: #9370DB; font-weight: 600; text-decoration: none; }

    .raffle-prize-card {
      display: flex;
      align-items: center;
      gap: 16px;
      background: #f5f0ff;
      border: 1px solid #d8b4fe;
      border-radius: 6px;
      padding: 16px 20px;
      margin-bottom: 16px;
    }

    .prize-logo {
      height: 44px;
      width: auto;
      object-fit: contain;
      flex-shrink: 0;
      border-radius: 4px;
      background: white;
      padding: 4px 8px;
      border: 1px solid #e2e8f0;
    }

    .prize-info { flex: 1; }

    .prize-name {
      font-size: 1rem;
      font-weight: 700;
      color: #6d28d9;
      margin: 0 0 4px;
    }

    .prize-desc {
      font-size: 0.8rem;
      color: #7B2FBE;
      margin: 0;
      line-height: 1.4;
    }

    .prize-odds {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: white;
      border-radius: 4px;
      padding: 10px 14px;
      border: 1px solid #d8b4fe;
      flex-shrink: 0;
      gap: 2px;
      min-width: 72px;
      text-align: center;
    }

    .odds-number {
      font-size: 1.25rem;
      font-weight: 700;
      color: #6d28d9;
      line-height: 1;
    }

    .odds-label {
      font-size: 0.62rem;
      color: #9370DB;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    .raffle-success {
      background: #f0fdf4;
      color: #16a34a;
      border: 1px solid #bbf7d0;
      border-radius: 4px;
      padding: 10px 14px;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .raffle-error-msg {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
      border-radius: 4px;
      padding: 10px 14px;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .tiers-heading {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #6b7280;
      margin: 0 0 12px;
    }

    .tiers-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    @media (max-width: 700px) {
      .tiers-grid { grid-template-columns: repeat(2, 1fr); }
    }

    .tier-card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 16px 12px;
      text-align: center;
      position: relative;
      transition: border-color 0.12s;
    }

    .tier-card:hover { border-color: #9370DB; }

    .tier-badge {
      position: absolute;
      top: -9px;
      left: 50%;
      transform: translateX(-50%);
      background: #9370DB;
      color: white;
      font-size: 0.67rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 3px;
      white-space: nowrap;
      letter-spacing: 0.03em;
    }

    .tier-count {
      font-size: 1.75rem;
      font-weight: 700;
      color: #0f172a;
      line-height: 1;
      margin-bottom: 3px;
      letter-spacing: -0.02em;
    }

    .tier-unit {
      font-size: 0.78rem;
      font-weight: 500;
      color: #6b7280;
    }

    .tier-label {
      font-size: 0.68rem;
      color: #9ca3af;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 10px;
    }

    .tier-cost {
      font-size: 1rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 3px;
    }

    .tier-savings {
      font-size: 0.72rem;
      color: #16a34a;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .tier-savings-placeholder {
      height: 16px;
      margin-bottom: 12px;
    }

    .tier-buy-btn {
      width: 100%;
      padding: 8px 0;
      background: #9370DB;
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.12s, opacity 0.12s;
    }

    .tier-buy-btn:hover:not(:disabled) { background: #7B2FBE; }
    .tier-buy-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .tier-buy-btn.cant-afford { background: #e2e8f0; color: #9ca3af; }

    .raffle-loading {
      text-align: center;
      padding: 32px;
      color: #9ca3af;
      font-size: 0.875rem;
    }

    /* ── Admin Panel ──────────────────────────────── */
    .tab-admin { }
    .tab-admin.active { background: #0f172a !important; }

    .admin-container {
      max-width: 640px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .admin-heading {
      font-size: 1rem;
      font-weight: 700;
      color: #0f172a;
      margin: 0;
    }

    .admin-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .admin-card-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: #0f172a;
      margin: 0;
    }

    .admin-card-hint {
      font-size: 0.8rem;
      color: #6b7280;
      margin: -6px 0 0;
    }

    .admin-closed-badge {
      display: inline-block;
      background: #fef3c7;
      color: #92400e;
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 3px 10px;
      border-radius: 3px;
      border: 1px solid #fde68a;
      width: fit-content;
    }

    .admin-open-badge {
      display: inline-block;
      background: #f0fdf4;
      color: #16a34a;
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 3px 10px;
      border-radius: 3px;
      border: 1px solid #bbf7d0;
      width: fit-content;
    }

    .admin-raffle-status-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .admin-draws-count {
      font-size: 0.78rem;
      color: #6b7280;
      font-weight: 500;
    }

    .admin-raffle-btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .admin-winners-list { display: flex; flex-direction: column; gap: 8px; }

    .admin-btn-outline {
      background: white;
      color: #374151;
      border: 1px solid #d1d5db !important;
    }

    .admin-btn-outline:hover:not(:disabled) { border-color: #9ca3af !important; background: #f9fafb; }

    .admin-winner-box {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 4px;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .admin-winner-label {
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #16a34a;
    }

    .admin-winner-name { font-size: 1.1rem; font-weight: 700; color: #14532d; }
    .admin-winner-email { font-size: 0.875rem; color: #166534; font-weight: 500; }
    .admin-winner-meta { font-size: 0.75rem; color: #6b7280; margin-top: 3px; }

    .admin-btn {
      padding: 8px 18px;
      border: none;
      border-radius: 4px;
      font-size: 0.825rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.12s, opacity 0.12s;
      width: fit-content;
    }

    .admin-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .admin-btn-primary { background: #9370DB; color: white; }
    .admin-btn-primary:hover:not(:disabled) { background: #7B2FBE; }

    .admin-btn-danger { background: #dc2626; color: white; }
    .admin-btn-danger:hover:not(:disabled) { background: #b91c1c; }

    .admin-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      border-radius: 4px;
      padding: 7px 10px;
      font-size: 0.8rem;
    }

    .admin-success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
      border-radius: 4px;
      padding: 7px 10px;
      font-size: 0.8rem;
    }

    /* ── Admin Tables ─── */
    .admin-table-wrap {
      overflow-x: auto;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      -webkit-overflow-scrolling: touch;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .admin-table thead tr {
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .admin-table th {
      padding: 8px 12px;
      text-align: left;
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      white-space: nowrap;
    }

    .admin-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #f1f5f9;
      color: #374151;
      white-space: nowrap;
    }

    .admin-table tbody tr:last-child td { border-bottom: none; }
    .admin-table tbody tr:hover td { background: #f8fafc; }

    .admin-td-bold { font-weight: 600; color: #0f172a; }
    .admin-td-num  { font-weight: 600; font-variant-numeric: tabular-nums; text-align: right; }
    .admin-td-muted { color: #9ca3af; font-size: 0.75rem; }

    .admin-settle-form { display: flex; flex-direction: column; gap: 10px; }
    .admin-form-row { display: flex; flex-direction: column; gap: 3px; }

    .admin-label {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
    }

    .admin-select {
      padding: 7px 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 0.875rem;
      background: white;
      color: #0f172a;
      width: 100%;
    }

    .admin-form-scores { display: flex; align-items: flex-end; gap: 10px; }
    .admin-score-field { display: flex; flex-direction: column; gap: 3px; flex: 1; }

    .admin-score-input {
      padding: 7px 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 700;
      text-align: center;
      width: 100%;
    }

    .admin-score-sep {
      font-size: 1.25rem;
      font-weight: 700;
      color: #9ca3af;
      padding-bottom: 5px;
    }

    /* ── Score Credibility Panel ── */
    .score-check-panel {
      border-radius: 4px;
      padding: 10px 14px;
      margin: 2px 0;
      font-size: 0.82rem;
      border: 1px solid;
    }
    .score-check-ok { background: #f5f0ff; border-color: #c4b5fd; color: #6d28d9; }
    .score-check-warning { background: #ede9fe; border-color: #a78bfa; color: #6d28d9; }
    .score-check-alert { background: #ddd6fe; border-color: #7c3aed; color: #5b21b6; }
    .score-check-loading { background: #faf5ff; border-color: #e9d5ff; color: #7c3aed; }
    .score-check-header { display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 4px; }
    .score-check-prob { margin-left: auto; font-weight: 400; font-size: 0.78rem; opacity: 0.8; }
    .score-check-meta { font-size: 0.78rem; opacity: 0.85; margin-bottom: 4px; }
    .score-check-flags { margin: 6px 0 0; padding-left: 18px; }
    .score-check-flags li { margin-bottom: 3px; }
    html.dark .score-check-ok { background: #1a0f2e; border-color: #6d28d9; color: #c4b5fd; }
    html.dark .score-check-warning { background: #1a0f2e; border-color: #7c3aed; color: #d8b4fe; }
    html.dark .score-check-alert { background: #200d3a; border-color: #9370DB; color: #e9d5ff; }
    html.dark .score-check-loading { background: #130a21; border-color: #4c1d95; color: #a78bfa; }

    /* ── Dark Mode Toggle ────────────────────────── */
    .dark-mode-toggle {
      width: 40px;
      height: 22px;
      border-radius: 11px;
      background: #d1d5db;
      border: none;
      cursor: pointer;
      position: relative;
      transition: background 0.2s;
      flex-shrink: 0;
      padding: 0;
    }
    .dark-mode-toggle.active {
      background: #9370DB;
    }
    .dark-mode-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: white;
      transition: transform 0.2s;
    }
    .dark-mode-toggle.active::after {
      transform: translateX(18px);
    }

    /* ── Dark Mode ───────────────────────────────── */
    html.dark body {
      background: #0f172a;
      color: #cbd5e1;
    }
    html.dark .date-dropdown {
      background-color: #1e293b;
      border-color: #334155;
      color: #e2e8f0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a78bfa' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
    }
    html.dark .navbar,
    html.dark .subnav,
    html.dark .market-card,
    html.dark .modal,
    html.dark .sport-sidebar,
    html.dark .portfolio-container,
    html.dark .raffle-container,
    html.dark .admin-card,
    html.dark .tier-card,
    html.dark .odds-card,
    html.dark .chat-message,
    html.dark .vote-btn,
    html.dark .expanded-game-modal {
      background: #1e293b;
      border-color: #334155;
    }
    html.dark .expanded-header {
      background: #162032;
      border-color: #334155;
    }
    html.dark .expanded-body {
      background: #0f172a;
    }
    html.dark .expanded-chart-section,
    html.dark .expanded-chat-section,
    html.dark .expanded-info-section {
      background: #1e293b;
      border-color: #334155;
    }
    html.dark .outcome-card,
    html.dark .trade-summary,
    html.dark .raffle-balance-bar,
    html.dark .chat-messages {
      background: #162032;
      border-color: #334155;
    }
    html.dark .position-card {
      background: #162032;
      border-color: #334155;
    }
    html.dark .market-stats {
      border-color: #334155;
    }
    html.dark .section-header {
      border-color: #334155;
    }
    html.dark .trading-section,
    html.dark .sell-options {
      border-color: #334155;
    }
    html.dark .modal-header {
      border-color: #334155;
    }
    html.dark .chat-input-section {
      border-color: #334155;
    }
    html.dark .chat-login-prompt {
      background: #162032;
    }
    html.dark .navbar {
      border-color: #334155;
    }
    html.dark .navbar-brand {
      border-right-color: #334155;
    }
    html.dark .nav-tab:hover { color: #cbd5e1; }
    html.dark .nav-tab.active {
      color: #c4b5fd;
      border-bottom-color: #c4b5fd;
    }
    html.dark .date-chip {
      border-color: #334155;
      color: #94a3b8;
    }
    html.dark .date-chip:hover {
      background: #162032;
      color: #cbd5e1;
    }
    html.dark .date-chip:not(:last-child) {
      border-right-color: #334155;
    }
    html.dark .sport-btn {
      color: #94a3b8;
      border-color: #334155;
    }
    html.dark .sport-btn:hover {
      background: #162032;
    }
    html.dark .sport-btn.active {
      background: #3b1a6e;
      color: #c4b5fd;
      border-color: #9370DB;
    }
    html.dark .brand-name {
      color: #f1f5f9;
    }
    html.dark .brand-sub {
      color: #64748b;
    }
    html.dark .amount {
      color: #f1f5f9;
    }
    html.dark .label {
      color: #64748b;
    }
    html.dark .matchup h3,
    html.dark .modal-header h2,
    html.dark .position-card h3,
    html.dark .admin-card-title,
    html.dark .admin-heading,
    html.dark .market-summary h3,
    html.dark .expanded-title h2,
    html.dark .odds-card .team-name,
    html.dark .info-value,
    html.dark .price-large,
    html.dark .tier-count {
      color: #f1f5f9;
    }
    html.dark .admin-table-wrap { border-color: #334155; }
    html.dark .admin-table thead tr { background: #162032; border-color: #334155; }
    html.dark .admin-table th { color: #64748b; }
    html.dark .admin-table td { color: #cbd5e1; border-bottom-color: #1e293b; }
    html.dark .admin-table tbody tr:hover td { background: #162032; }
    html.dark .admin-td-bold { color: #f1f5f9; }
    html.dark .admin-td-muted { color: #475569; }
    html.dark .game-info,
    html.dark .market-stats,
    html.dark .admin-card-hint,
    html.dark .info-label,
    html.dark .sidebar-title,
    html.dark .section-title,
    html.dark .tiers-heading,
    html.dark .section-header h3 {
      color: #64748b;
    }
    html.dark .shares-info,
    html.dark .message-content {
      color: #94a3b8;
    }
    html.dark .team-name {
      color: #cbd5e1;
    }
    html.dark .elo-badge {
      background: #162032;
      border-color: #334155;
      color: #64748b;
    }
    html.dark .sport-badge {
      background: #162032;
      border-color: #334155;
      color: #64748b;
    }
    html.dark .price {
      color: #c4b5fd;
    }
    html.dark .buy-btn {
      background: #9370DB;
    }
    html.dark .form-input,
    html.dark .amount-input,
    html.dark .chat-input,
    html.dark .admin-select,
    html.dark .admin-score-input,
    html.dark .score-input {
      background: #162032;
      border-color: #334155;
      color: #f1f5f9;
    }
    html.dark .form-input:focus,
    html.dark .amount-input:focus,
    html.dark .chat-input:focus {
      border-color: #9370DB;
    }
    html.dark .quick-btn {
      background: #162032;
      border-color: #334155;
      color: #94a3b8;
    }
    html.dark .chart-view-btn {
      border-color: #334155;
      color: #94a3b8;
    }
    html.dark .chart-view-btn:hover {
      border-color: #9370DB;
      color: #c4b5fd;
    }
    html.dark .close-btn {
      color: #64748b;
    }
    html.dark .close-btn:hover {
      background: #162032;
      color: #cbd5e1;
    }
    html.dark .btn-login {
      background: transparent;
      color: #94a3b8;
      border-color: #334155;
    }
    html.dark .btn-login:hover {
      background: #162032;
    }
    html.dark .btn-logout {
      border-color: #334155;
      color: #64748b;
    }
    html.dark .btn-logout:hover {
      background: #2d1a1a;
      color: #f87171;
      border-color: #7f1d1d;
    }
    html.dark .score-report-msg {
      background: #1a0f2e !important;
      border-color: #6d28d9 !important;
    }
    html.dark .score-report-msg .score-report-label { color: #c4b5fd; }
    html.dark .srb-team-name { color: #e2e8f0; }
    html.dark .srb-score { color: #c4b5fd; }
    html.dark .srb-row:first-child { border-bottom-color: #3b1a6e; }
    html.dark .score-report-form {
      background: #1a0f2e;
      border-color: #6d28d9;
    }
    html.dark .score-report-toggle-btn {
      background: #1a0f2e;
      border-color: #6d28d9;
      color: #c4b5fd;
    }
    html.dark .score-report-toggle-btn:hover { background: #2d1557; }
    html.dark .score-team-label { color: #cbd5e1; }
    html.dark .score-sep { color: #94a3b8; }
    html.dark .submit-score-btn { background: #7c3aed; }
    html.dark .submit-score-btn:hover:not(:disabled) { background: #6d28d9; }
    html.dark .admin-winner-box {
      background: #0d231a;
      border-color: #166534;
    }
    html.dark .sell-btn {
      border-color: #7f1d1d;
      color: #f87171;
    }
    html.dark .sell-btn:hover {
      background: #2d1a1a;
    }
    html.dark .raffle-prize-card {
      background: #1e1433;
      border-color: #7B2FBE;
    }
    html.dark .prize-odds {
      background: #162032;
      border-color: #7B2FBE;
    }
    html.dark .tier-card:hover {
      border-color: #9370DB;
    }
    html.dark .market-card:hover {
      border-color: #334155;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
    html.dark .market-card.clickable:hover {
      border-color: #9370DB;
    }
    html.dark .outcome-option {
      background: #162032;
      border-color: #334155;
    }
    html.dark .outcome-option.active {
      border-color: #9370DB;
      background: #3b1a6e;
    }
    html.dark .spinner {
      border-color: #334155;
      border-top-color: #9370DB;
    }
    html.dark .loading,
    html.dark .error,
    html.dark .no-markets,
    html.dark .no-positions {
      background: #1e293b;
      border-color: #334155;
      color: #64748b;
    }
    html.dark .dark-mode-toggle {
      background: #334155;
    }
    html.dark .dark-mode-toggle.active {
      background: #9370DB;
    }

    /* ── Custom Scrollbars ───────────────────────── */
    /* Webkit (Chrome, Edge, Safari) */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #e2e8f0;
      border-radius: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      border: 2px solid #e2e8f0;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #5a6fd6 0%, #6a3f92 100%);
    }
    ::-webkit-scrollbar-corner {
      background: #e2e8f0;
    }

    /* Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: #667eea #e2e8f0;
    }

    /* Dark mode scrollbars */
    html.dark ::-webkit-scrollbar-track {
      background: #1e293b;
      border-color: #1e293b;
    }
    html.dark ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #7c3aed 0%, #9333ea 100%);
      border-color: #1e293b;
    }
    html.dark ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #6d28d9 0%, #7e22ce 100%);
    }
    html.dark ::-webkit-scrollbar-corner {
      background: #1e293b;
    }
    html.dark * {
      scrollbar-color: #7c3aed #1e293b;
    }

    /* ── Dark mode + mobile overrides ── */
    @media (max-width: 768px) {
      html.dark .navbar-tabs { border-top-color: #334155; }
    }
  </style>
</body>
</html>
